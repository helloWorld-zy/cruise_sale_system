# Sprint 5: 智能发现与决策支持 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 完成智能推荐、航线日历、价格趋势、最佳预订时机与舱位对比的完整闭环，并在后台/前台/小程序/CI上落地。

**Architecture:** 后端新增推荐与分析服务，提供REST接口与可复用的数据模型；前端在管理端配置推荐权重与趋势面板，Web/小程序展示推荐、日历、趋势与对比功能。

**Tech Stack:** Go 1.26, Gin, GORM, PostgreSQL 17, Redis 7.4, Nuxt 4, Vue 3, Pinia, Vitest, Playwright, uni-app, Jest.

---

## Part A: Backend (Tasks 1-6)

### Task 1: 用户偏好 + 推荐权重 Domain/Repository

**Files:**
- Create: `backend/internal/domain/preference.go`
- Create: `backend/internal/domain/recommendation_weight.go`
- Create: `backend/internal/domain/preference_test.go`
- Create: `backend/internal/repository/preference_repo.go`
- Create: `backend/internal/repository/preference_repo_test.go`

**Step 1: Write the failing test**

Create `backend/internal/domain/preference_test.go`:

```go
package domain

import "testing"

func TestPreferenceModel(t *testing.T) {
    p := UserPreference{UserID: 1, Tags: []string{"family", "ocean"}}
    if p.UserID != 1 || len(p.Tags) != 2 {
        t.Fatal("expected preference fields")
    }
}
```

Create `backend/internal/repository/preference_repo_test.go`:

```go
package repository

import (
    "testing"

    "github.com/cruisebooking/backend/internal/domain"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

func TestPreferenceRepoUpsert(t *testing.T) {
    db, _ := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    _ = db.AutoMigrate(&domain.UserPreference{})
    repo := NewPreferenceRepository(db)
    err := repo.Upsert(&domain.UserPreference{UserID: 1, Tags: []string{"family"}})
    if err != nil {
        t.Fatal(err)
    }
    got, err := repo.GetByUserID(1)
    if err != nil || got.UserID != 1 {
        t.Fatal("expected preference")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/domain ./internal/repository -run TestPreference -v`
Expected: FAIL with "undefined: UserPreference"

**Step 3: Write minimal implementation**

Create `backend/internal/domain/preference.go`:

```go
package domain

import "time"

type UserPreference struct {
    ID        int64     `gorm:"primaryKey"`
    UserID    int64     `gorm:"uniqueIndex"`
    Tags      []string  `gorm:"type:json"`
    UpdatedAt time.Time
}
```

Create `backend/internal/domain/recommendation_weight.go`:

```go
package domain

import "time"

type RecommendationWeight struct {
    ID         int64     `gorm:"primaryKey"`
    Tag        string    `gorm:"uniqueIndex"`
    Weight     float64
    UpdatedAt  time.Time
}
```

Create `backend/internal/repository/preference_repo.go`:

```go
package repository

import (
    "github.com/cruisebooking/backend/internal/domain"
    "gorm.io/gorm"
)

type PreferenceRepository struct { db *gorm.DB }

func NewPreferenceRepository(db *gorm.DB) *PreferenceRepository { return &PreferenceRepository{db: db} }

func (r *PreferenceRepository) Upsert(p *domain.UserPreference) error {
    return r.db.Save(p).Error
}

func (r *PreferenceRepository) GetByUserID(userID int64) (*domain.UserPreference, error) {
    var p domain.UserPreference
    if err := r.db.Where("user_id = ?", userID).First(&p).Error; err != nil {
        return nil, err
    }
    return &p, nil
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/domain ./internal/repository -run TestPreference -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/domain backend/internal/repository
git commit -m "feat: add user preference models and repo"
```

---

### Task 2: 推荐计算服务

**Files:**
- Create: `backend/internal/service/recommendation_service.go`
- Create: `backend/internal/service/recommendation_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/recommendation_service_test.go`:

```go
package service

import "testing"

func TestRecommendOrdersByScore(t *testing.T) {
    svc := NewRecommendationService(map[string]float64{"family": 2})
    items := []Candidate{{ID: 1, Tags: []string{"family"}}, {ID: 2, Tags: []string{"luxury"}}}
    got := svc.Recommend(items, []string{"family"}, 1)
    if len(got) != 1 || got[0].ID != 1 {
        t.Fatal("expected family cruise first")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestRecommendOrdersByScore -v`
Expected: FAIL with "undefined: NewRecommendationService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/recommendation_service.go`:

```go
package service

import "sort"

type Candidate struct {
    ID   int64
    Tags []string
}

type RecommendationService struct {
    weights map[string]float64
}

func NewRecommendationService(weights map[string]float64) *RecommendationService {
    return &RecommendationService{weights: weights}
}

func (s *RecommendationService) score(item Candidate, prefs []string) float64 {
    score := 0.0
    for _, p := range prefs {
        for _, t := range item.Tags {
            if p == t {
                score += s.weights[p]
            }
        }
    }
    return score
}

func (s *RecommendationService) Recommend(items []Candidate, prefs []string, limit int) []Candidate {
    sort.Slice(items, func(i, j int) bool {
        return s.score(items[i], prefs) > s.score(items[j], prefs)
    })
    if len(items) > limit {
        return items[:limit]
    }
    return items
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestRecommendOrdersByScore -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/recommendation_service.go backend/internal/service/recommendation_service_test.go
git commit -m "feat: add recommendation scoring service"
```

---

### Task 3: 推荐与偏好 API

**Files:**
- Create: `backend/internal/handler/recommendation_handler.go`
- Create: `backend/internal/handler/recommendation_handler_test.go`
- Modify: `backend/internal/router/router.go`

**Step 1: Write the failing test**

Create `backend/internal/handler/recommendation_handler_test.go`:

```go
package handler

import (
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/gin-gonic/gin"
)

type fakeRecommendSvc struct{}

func (fakeRecommendSvc) Recommend(userID int64) []int64 { return []int64{1} }

func TestRecommendHandler(t *testing.T) {
    r := gin.New()
    h := NewRecommendationHandler(fakeRecommendSvc{})
    r.GET("/api/recommend", h.Get)
    w := httptest.NewRecorder()
    r.ServeHTTP(w, httptest.NewRequest("GET", "/api/recommend?user_id=1", nil))
    if w.Code != http.StatusOK {
        t.Fatalf("expected 200, got %d", w.Code)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/handler -run TestRecommendHandler -v`
Expected: FAIL with "undefined: NewRecommendationHandler"

**Step 3: Write minimal implementation**

Create `backend/internal/handler/recommendation_handler.go`:

```go
package handler

import (
    "net/http"
    "strconv"

    "github.com/gin-gonic/gin"
)

type RecommendService interface {
    Recommend(userID int64) []int64
}

type RecommendationHandler struct { svc RecommendService }

func NewRecommendationHandler(svc RecommendService) *RecommendationHandler {
    return &RecommendationHandler{svc: svc}
}

func (h *RecommendationHandler) Get(c *gin.Context) {
    userID, _ := strconv.ParseInt(c.Query("user_id"), 10, 64)
    ids := h.svc.Recommend(userID)
    c.JSON(http.StatusOK, gin.H{"items": ids})
}
```

Modify `backend/internal/router/router.go`:

```go
// register recommendation handler with existing router group
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/handler -run TestRecommendHandler -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/handler/recommendation_handler.go backend/internal/handler/recommendation_handler_test.go backend/internal/router/router.go
git commit -m "feat: add recommendation handler"
```

---

### Task 4: 航线日历最低价与趋势分析服务

**Files:**
- Create: `backend/internal/service/price_analytics.go`
- Create: `backend/internal/service/price_analytics_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/price_analytics_test.go`:

```go
package service

import "testing"

func TestMinPriceByDate(t *testing.T) {
    svc := NewPriceAnalyticsService()
    prices := []PricePoint{{Date: "2026-03-01", Price: 2000}, {Date: "2026-03-01", Price: 1500}}
    got := svc.MinByDate(prices)
    if got["2026-03-01"] != 1500 {
        t.Fatal("expected min price")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestMinPriceByDate -v`
Expected: FAIL with "undefined: NewPriceAnalyticsService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/price_analytics.go`:

```go
package service

type PricePoint struct {
    Date  string
    Price int64
}

type PriceAnalyticsService struct{}

func NewPriceAnalyticsService() *PriceAnalyticsService { return &PriceAnalyticsService{} }

func (s *PriceAnalyticsService) MinByDate(points []PricePoint) map[string]int64 {
    out := map[string]int64{}
    for _, p := range points {
        if v, ok := out[p.Date]; !ok || p.Price < v {
            out[p.Date] = p.Price
        }
    }
    return out
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestMinPriceByDate -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/price_analytics.go backend/internal/service/price_analytics_test.go
git commit -m "feat: add price analytics service"
```

---

### Task 5: 价格趋势 API

**Files:**
- Create: `backend/internal/handler/price_analytics_handler.go`
- Create: `backend/internal/handler/price_analytics_handler_test.go`

**Step 1: Write the failing test**

Create `backend/internal/handler/price_analytics_handler_test.go`:

```go
package handler

import (
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/gin-gonic/gin"
)

type fakePriceSvc struct{}

func (fakePriceSvc) Calendar(routeID int64) map[string]int64 { return map[string]int64{"2026-03-01": 1500} }

func TestCalendarHandler(t *testing.T) {
    r := gin.New()
    h := NewPriceAnalyticsHandler(fakePriceSvc{})
    r.GET("/api/calendar", h.Calendar)
    w := httptest.NewRecorder()
    r.ServeHTTP(w, httptest.NewRequest("GET", "/api/calendar?route_id=1", nil))
    if w.Code != http.StatusOK {
        t.Fatalf("expected 200, got %d", w.Code)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/handler -run TestCalendarHandler -v`
Expected: FAIL with "undefined: NewPriceAnalyticsHandler"

**Step 3: Write minimal implementation**

Create `backend/internal/handler/price_analytics_handler.go`:

```go
package handler

import (
    "net/http"
    "strconv"

    "github.com/gin-gonic/gin"
)

type PriceAnalyticsService interface {
    Calendar(routeID int64) map[string]int64
}

type PriceAnalyticsHandler struct { svc PriceAnalyticsService }

func NewPriceAnalyticsHandler(svc PriceAnalyticsService) *PriceAnalyticsHandler {
    return &PriceAnalyticsHandler{svc: svc}
}

func (h *PriceAnalyticsHandler) Calendar(c *gin.Context) {
    routeID, _ := strconv.ParseInt(c.Query("route_id"), 10, 64)
    c.JSON(http.StatusOK, h.svc.Calendar(routeID))
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/handler -run TestCalendarHandler -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/handler/price_analytics_handler.go backend/internal/handler/price_analytics_handler_test.go
git commit -m "feat: add price analytics handler"
```

---

### Task 6: 舱位对比 API

**Files:**
- Create: `backend/internal/handler/compare_handler.go`
- Create: `backend/internal/handler/compare_handler_test.go`

**Step 1: Write the failing test**

Create `backend/internal/handler/compare_handler_test.go`:

```go
package handler

import (
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/gin-gonic/gin"
)

type fakeCompareSvc struct{}

func (fakeCompareSvc) Compare(ids []int64) []int64 { return ids }

func TestCompareHandler(t *testing.T) {
    r := gin.New()
    h := NewCompareHandler(fakeCompareSvc{})
    r.GET("/api/compare", h.Get)
    w := httptest.NewRecorder()
    r.ServeHTTP(w, httptest.NewRequest("GET", "/api/compare?ids=1,2,3", nil))
    if w.Code != http.StatusOK {
        t.Fatalf("expected 200, got %d", w.Code)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/handler -run TestCompareHandler -v`
Expected: FAIL with "undefined: NewCompareHandler"

**Step 3: Write minimal implementation**

Create `backend/internal/handler/compare_handler.go`:

```go
package handler

import (
    "net/http"
    "strconv"
    "strings"

    "github.com/gin-gonic/gin"
)

type CompareService interface {
    Compare(ids []int64) []int64
}

type CompareHandler struct { svc CompareService }

func NewCompareHandler(svc CompareService) *CompareHandler { return &CompareHandler{svc: svc} }

func (h *CompareHandler) Get(c *gin.Context) {
    raw := strings.Split(c.Query("ids"), ",")
    ids := make([]int64, 0, len(raw))
    for _, v := range raw {
        if v == "" { continue }
        id, _ := strconv.ParseInt(v, 10, 64)
        ids = append(ids, id)
    }
    c.JSON(http.StatusOK, gin.H{"items": h.svc.Compare(ids)})
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/handler -run TestCompareHandler -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/handler/compare_handler.go backend/internal/handler/compare_handler_test.go
git commit -m "feat: add cabin comparison handler"
```

---

## Part B: Admin (Tasks 7-8)

### Task 7: 推荐权重配置页面

**Files:**
- Create: `frontend/admin/pages/recommendation/weights.vue`
- Create: `frontend/admin/composables/useRecommendationWeights.ts`
- Test: `frontend/admin/tests/unit/recommendation-weights.spec.ts`

**Step 1: Write the failing test**

Create `frontend/admin/tests/unit/recommendation-weights.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import WeightsPage from '@/pages/recommendation/weights.vue'

describe('RecommendationWeights', () => {
  it('renders weight rows', () => {
    const wrapper = mount(WeightsPage, { global: { stubs: ['NuxtPage'] } })
    expect(wrapper.text()).toContain('推荐权重')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/admin && pnpm vitest run tests/unit/recommendation-weights.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/admin/composables/useRecommendationWeights.ts`:

```ts
export interface WeightItem { tag: string; weight: number }

export const useRecommendationWeights = () => {
  const items = ref<WeightItem[]>([{ tag: 'family', weight: 2 }])
  return { items }
}
```

Create `frontend/admin/pages/recommendation/weights.vue`:

```vue
<script setup lang="ts">
const { items } = useRecommendationWeights()
</script>

<template>
  <section>
    <h1>推荐权重</h1>
    <ul>
      <li v-for="item in items" :key="item.tag">{{ item.tag }} - {{ item.weight }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/admin && pnpm vitest run tests/unit/recommendation-weights.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/admin/pages/recommendation/weights.vue frontend/admin/composables/useRecommendationWeights.ts frontend/admin/tests/unit/recommendation-weights.spec.ts
git commit -m "feat: add admin recommendation weight page"
```

---

### Task 8: 价格趋势与日历面板

**Files:**
- Create: `frontend/admin/pages/analytics/pricing.vue`
- Test: `frontend/admin/tests/unit/analytics-pricing.spec.ts`

**Step 1: Write the failing test**

Create `frontend/admin/tests/unit/analytics-pricing.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import PricingPage from '@/pages/analytics/pricing.vue'

describe('PricingAnalytics', () => {
  it('shows calendar section', () => {
    const wrapper = mount(PricingPage)
    expect(wrapper.text()).toContain('航线日历')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/admin && pnpm vitest run tests/unit/analytics-pricing.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/admin/pages/analytics/pricing.vue`:

```vue
<script setup lang="ts">
const calendar = ref([{ date: '2026-03-01', price: 1500 }])
</script>

<template>
  <section>
    <h1>价格分析</h1>
    <h2>航线日历</h2>
    <ul>
      <li v-for="item in calendar" :key="item.date">{{ item.date }} - {{ item.price }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/admin && pnpm vitest run tests/unit/analytics-pricing.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/admin/pages/analytics/pricing.vue frontend/admin/tests/unit/analytics-pricing.spec.ts
git commit -m "feat: add admin pricing analytics page"
```

---

## Part C: Web (Tasks 9-12)

### Task 9: 首页个性化推荐卡片

**Files:**
- Create: `frontend/web/components/RecommendationCards.vue`
- Test: `frontend/web/tests/unit/recommendation-cards.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/recommendation-cards.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import RecommendationCards from '@/components/RecommendationCards.vue'

describe('RecommendationCards', () => {
  it('renders recommendations', () => {
    const wrapper = mount(RecommendationCards, { props: { items: [{ id: 1, title: 'Family Cruise' }] } })
    expect(wrapper.text()).toContain('Family Cruise')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/recommendation-cards.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/web/components/RecommendationCards.vue`:

```vue
<script setup lang="ts">
defineProps<{ items: { id: number; title: string }[] }>()
</script>

<template>
  <section>
    <h2>为你推荐</h2>
    <div v-for="item in items" :key="item.id">{{ item.title }}</div>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/recommendation-cards.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/components/RecommendationCards.vue frontend/web/tests/unit/recommendation-cards.spec.ts
git commit -m "feat: add web recommendation cards"
```

---

### Task 10: 航线日历页面

**Files:**
- Create: `frontend/web/pages/calendar.vue`
- Test: `frontend/web/tests/unit/calendar-page.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/calendar-page.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import CalendarPage from '@/pages/calendar.vue'

describe('CalendarPage', () => {
  it('shows calendar heading', () => {
    const wrapper = mount(CalendarPage)
    expect(wrapper.text()).toContain('航线日历')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/calendar-page.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/web/pages/calendar.vue`:

```vue
<script setup lang="ts">
const days = ref([{ date: '2026-03-01', price: 1500 }])
</script>

<template>
  <section>
    <h1>航线日历</h1>
    <ul>
      <li v-for="d in days" :key="d.date">{{ d.date }} - {{ d.price }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/calendar-page.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/pages/calendar.vue frontend/web/tests/unit/calendar-page.spec.ts
git commit -m "feat: add web calendar page"
```

---

### Task 11: 价格趋势组件

**Files:**
- Create: `frontend/web/components/PriceTrend.vue`
- Test: `frontend/web/tests/unit/price-trend.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/price-trend.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import PriceTrend from '@/components/PriceTrend.vue'

describe('PriceTrend', () => {
  it('renders trend title', () => {
    const wrapper = mount(PriceTrend, { props: { points: [{ date: '2026-03-01', price: 1500 }] } })
    expect(wrapper.text()).toContain('价格趋势')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/price-trend.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/web/components/PriceTrend.vue`:

```vue
<script setup lang="ts">
defineProps<{ points: { date: string; price: number }[] }>()
</script>

<template>
  <section>
    <h3>价格趋势</h3>
    <ul>
      <li v-for="p in points" :key="p.date">{{ p.date }} - {{ p.price }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/price-trend.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/components/PriceTrend.vue frontend/web/tests/unit/price-trend.spec.ts
git commit -m "feat: add web price trend component"
```

---

### Task 12: 舱位对比页面

**Files:**
- Create: `frontend/web/pages/compare.vue`
- Test: `frontend/web/tests/unit/compare-page.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/compare-page.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import ComparePage from '@/pages/compare.vue'

describe('ComparePage', () => {
  it('renders compare heading', () => {
    const wrapper = mount(ComparePage)
    expect(wrapper.text()).toContain('舱位对比')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/compare-page.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/web/pages/compare.vue`:

```vue
<script setup lang="ts">
const items = ref([{ id: 1, name: 'Deluxe Cabin' }])
</script>

<template>
  <section>
    <h1>舱位对比</h1>
    <div v-for="item in items" :key="item.id">{{ item.name }}</div>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/compare-page.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/pages/compare.vue frontend/web/tests/unit/compare-page.spec.ts
git commit -m "feat: add web cabin comparison page"
```

---

## Part D: Miniapp (Tasks 13-14)

### Task 13: 小程序推荐与日历

**Files:**
- Create: `frontend/miniapp/pages/recommend/index.vue`
- Create: `frontend/miniapp/pages/calendar/index.vue`
- Test: `frontend/miniapp/tests/recommend.spec.ts`

**Step 1: Write the failing test**

Create `frontend/miniapp/tests/recommend.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import RecommendPage from '@/pages/recommend/index.vue'

describe('Miniapp Recommend', () => {
  it('renders title', () => {
    expect(RecommendPage).toBeTruthy()
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/miniapp && pnpm vitest run tests/recommend.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/miniapp/pages/recommend/index.vue`:

```vue
<script setup lang="ts">
const items = ref([{ id: 1, title: 'Family Cruise' }])
</script>

<template>
  <view>
    <text>为你推荐</text>
    <view v-for="item in items" :key="item.id">{{ item.title }}</view>
  </view>
</template>
```

Create `frontend/miniapp/pages/calendar/index.vue`:

```vue
<script setup lang="ts">
const days = ref([{ date: '2026-03-01', price: 1500 }])
</script>

<template>
  <view>
    <text>航线日历</text>
    <view v-for="d in days" :key="d.date">{{ d.date }} - {{ d.price }}</view>
  </view>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/miniapp && pnpm vitest run tests/recommend.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/miniapp/pages/recommend/index.vue frontend/miniapp/pages/calendar/index.vue frontend/miniapp/tests/recommend.spec.ts
git commit -m "feat: add miniapp recommend and calendar pages"
```

---

### Task 14: 小程序舱位对比页

**Files:**
- Create: `frontend/miniapp/pages/compare/index.vue`
- Test: `frontend/miniapp/tests/compare.spec.ts`

**Step 1: Write the failing test**

Create `frontend/miniapp/tests/compare.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import ComparePage from '@/pages/compare/index.vue'

describe('Miniapp Compare', () => {
  it('loads compare page', () => {
    expect(ComparePage).toBeTruthy()
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/miniapp && pnpm vitest run tests/compare.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/miniapp/pages/compare/index.vue`:

```vue
<script setup lang="ts">
const items = ref([{ id: 1, name: 'Deluxe Cabin' }])
</script>

<template>
  <view>
    <text>舱位对比</text>
    <view v-for="item in items" :key="item.id">{{ item.name }}</view>
  </view>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/miniapp && pnpm vitest run tests/compare.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/miniapp/pages/compare/index.vue frontend/miniapp/tests/compare.spec.ts
git commit -m "feat: add miniapp compare page"
```

---

## Part E: CI (Task 15)

### Task 15: 更新 CI 覆盖推荐与分析测试

**Files:**
- Modify: `.github/workflows/ci.yml`

**Step 1: Write the failing test**

Create `scripts/verify_ci_sprint5_test.go`:

```go
package scripts

import (
    "os"
    "testing"
)

func TestCISprint5IncludesWebAndMiniapp(t *testing.T) {
    b, err := os.ReadFile(".github/workflows/ci.yml")
    if err != nil {
        t.Fatal(err)
    }
    if string(b) == "" {
        t.Fatal("expected ci workflow")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `go test ./scripts -run TestCISprint5IncludesWebAndMiniapp -v`
Expected: FAIL if file missing or empty

**Step 3: Write minimal implementation**

Modify `.github/workflows/ci.yml` to add steps for:

```yaml
- name: Test Web
  run: cd frontend/web && pnpm vitest run
- name: Test Miniapp
  run: cd frontend/miniapp && pnpm vitest run
```

**Step 4: Run test to verify it passes**

Run: `go test ./scripts -run TestCISprint5IncludesWebAndMiniapp -v`
Expected: PASS

**Step 5: Commit**

```bash
git add .github/workflows/ci.yml scripts/verify_ci_sprint5_test.go
git commit -m "ci: cover sprint5 web and miniapp tests"
```

---

## Final Verification

Run:

```bash
cd backend && go test ./... -v
cd frontend/admin && pnpm vitest run
cd frontend/web && pnpm vitest run
cd frontend/miniapp && pnpm vitest run
```

Expected: All tests pass.
