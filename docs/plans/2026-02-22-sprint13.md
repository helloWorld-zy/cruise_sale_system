# Sprint 13: 价格对比 + 多语言 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 实现价格对比工具和多语言（简体/繁体/英文）基础能力与翻译管理。

**Architecture:** 后端提供价格对比与翻译条目API；后台进行翻译管理；Web/小程序支持语言切换与对比展示。TDD驱动最小实现。

**Tech Stack:** Go 1.26, Gin, GORM, PostgreSQL, Nuxt 4 (admin/web), Vue 3, Pinia, Vitest, Playwright, uni-app, vue-i18n.

---

## Part A: Backend (Tasks 1-4)

### Task 1: 价格对比与翻译模型

**Files:**
- Create: `backend/internal/domain/price_compare.go`
- Create: `backend/internal/domain/translation.go`
- Test: `backend/internal/domain/i18n_domain_test.go`

**Step 1: Write the failing test**

Create `backend/internal/domain/i18n_domain_test.go`:

```go
package domain

import "testing"

func TestTranslationModel(t *testing.T) {
    t1 := Translation{Key: "home.title", Locale: "en"}
    if t1.Key == "" || t1.Locale == "" {
        t.Fatal("expected translation fields")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/domain -run TestTranslationModel -v`
Expected: FAIL with "undefined: Translation"

**Step 3: Write minimal implementation**

Create `backend/internal/domain/price_compare.go`:

```go
package domain

import "time"

type PriceCompareItem struct {
    ID int64 `gorm:"primaryKey"`
    CabinID int64
    CruiseID int64
    Price int64
    CreatedAt time.Time
}
```

Create `backend/internal/domain/translation.go`:

```go
package domain

import "time"

type Translation struct {
    ID int64 `gorm:"primaryKey"`
    Key string `gorm:"size:200"`
    Locale string `gorm:"size:10"`
    Value string `gorm:"type:text"`
    UpdatedAt time.Time
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/domain -run TestTranslationModel -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/domain/price_compare.go backend/internal/domain/translation.go backend/internal/domain/i18n_domain_test.go
git commit -m "feat: add price compare and translation models"
```

---

### Task 2: 价格对比服务

**Files:**
- Create: `backend/internal/service/compare_service.go`
- Test: `backend/internal/service/compare_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/compare_service_test.go`:

```go
package service

import "testing"

func TestCompareMinPrice(t *testing.T) {
    svc := NewCompareService()
    min := svc.MinPrice([]int64{100, 80, 120})
    if min != 80 { t.Fatalf("expected 80, got %d", min) }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestCompareMinPrice -v`
Expected: FAIL with "undefined: NewCompareService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/compare_service.go`:

```go
package service

type CompareService struct{}

func NewCompareService() *CompareService { return &CompareService{} }

func (s *CompareService) MinPrice(values []int64) int64 {
    if len(values) == 0 { return 0 }
    min := values[0]
    for _, v := range values {
        if v < min { min = v }
    }
    return min
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestCompareMinPrice -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/compare_service.go backend/internal/service/compare_service_test.go
git commit -m "feat: add compare service"
```

---

### Task 3: 价格对比 API

**Files:**
- Create: `backend/internal/handler/compare_handler.go`
- Test: `backend/internal/handler/compare_handler_test.go`

**Step 1: Write the failing test**

Create `backend/internal/handler/compare_handler_test.go`:

```go
package handler

import (
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/gin-gonic/gin"
)

func TestCompareAPI(t *testing.T) {
    r := gin.New()
    h := NewCompareHandler()
    r.GET("/compare", h.Compare)
    w := httptest.NewRecorder()
    r.ServeHTTP(w, httptest.NewRequest("GET", "/compare", nil))
    if w.Code != http.StatusOK { t.Fatalf("expected 200, got %d", w.Code) }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/handler -run TestCompareAPI -v`
Expected: FAIL

**Step 3: Write minimal implementation**

Create `backend/internal/handler/compare_handler.go`:

```go
package handler

import "github.com/gin-gonic/gin"

type CompareHandler struct{}

func NewCompareHandler() *CompareHandler { return &CompareHandler{} }

func (h *CompareHandler) Compare(c *gin.Context) { c.JSON(200, gin.H{"items": []string{}}) }
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/handler -run TestCompareAPI -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/handler/compare_handler.go backend/internal/handler/compare_handler_test.go
git commit -m "feat: add compare handler"
```

---

### Task 4: 翻译条目 API

**Files:**
- Create: `backend/internal/handler/translation_handler.go`
- Test: `backend/internal/handler/translation_handler_test.go`

**Step 1: Write the failing test**

Create `backend/internal/handler/translation_handler_test.go`:

```go
package handler

import (
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/gin-gonic/gin"
)

func TestTranslationListAPI(t *testing.T) {
    r := gin.New()
    h := NewTranslationHandler()
    r.GET("/translations", h.List)
    w := httptest.NewRecorder()
    r.ServeHTTP(w, httptest.NewRequest("GET", "/translations", nil))
    if w.Code != http.StatusOK { t.Fatalf("expected 200, got %d", w.Code) }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/handler -run TestTranslationListAPI -v`
Expected: FAIL

**Step 3: Write minimal implementation**

Create `backend/internal/handler/translation_handler.go`:

```go
package handler

import "github.com/gin-gonic/gin"

type TranslationHandler struct{}

func NewTranslationHandler() *TranslationHandler { return &TranslationHandler{} }

func (h *TranslationHandler) List(c *gin.Context) { c.JSON(200, gin.H{"items": []string{}}) }
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/handler -run TestTranslationListAPI -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/handler/translation_handler.go backend/internal/handler/translation_handler_test.go
git commit -m "feat: add translation handler"
```

---

## Part B: Admin (Task 5)

> Follow @vue-best-practices and @vue-testing-best-practices.

### Task 5: 翻译管理页面

**Files:**
- Create: `frontend/admin/pages/i18n/translations.vue`
- Test: `frontend/admin/tests/unit/i18n/translations.spec.ts`

**Step 1: Write the failing test**

Create `frontend/admin/tests/unit/i18n/translations.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import TranslationsPage from '@/pages/i18n/translations.vue'

describe('TranslationsPage', () => {
  it('renders heading', () => {
    const wrapper = mount(TranslationsPage)
    expect(wrapper.text()).toContain('Translations')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/admin && pnpm vitest run tests/unit/i18n/translations.spec.ts`
Expected: FAIL

**Step 3: Write minimal implementation**

Create `frontend/admin/pages/i18n/translations.vue`:

```vue
<script setup lang="ts">
const items = ref([{ key: 'home.title', locale: 'en', value: 'Home' }])
</script>

<template>
  <section>
    <h1>Translations</h1>
    <ul>
      <li v-for="t in items" :key="t.key + t.locale">{{ t.key }} - {{ t.value }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/admin && pnpm vitest run tests/unit/i18n/translations.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/admin/pages/i18n/translations.vue frontend/admin/tests/unit/i18n/translations.spec.ts
git commit -m "feat: add translations admin page"
```

---

## Part C: Web (Task 6)

### Task 6: 价格对比页面

**Files:**
- Create: `frontend/web/pages/compare.vue`
- Test: `frontend/web/tests/unit/compare.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/compare.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import ComparePage from '@/pages/compare.vue'

describe('ComparePage', () => {
  it('renders compare heading', () => {
    const wrapper = mount(ComparePage)
    expect(wrapper.text()).toContain('Price Compare')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/compare.spec.ts`
Expected: FAIL

**Step 3: Write minimal implementation**

Create `frontend/web/pages/compare.vue`:

```vue
<script setup lang="ts">
const items = ref([{ name: 'Cabin A', price: 100 }])
</script>

<template>
  <section>
    <h1>Price Compare</h1>
    <ul>
      <li v-for="i in items" :key="i.name">{{ i.name }} - {{ i.price }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/compare.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/pages/compare.vue frontend/web/tests/unit/compare.spec.ts
git commit -m "feat: add price compare page"
```

---

## Part D: Miniapp (Task 7)

### Task 7: 小程序语言切换

**Files:**
- Create: `frontend/miniapp/pages/settings/language.vue`
- Test: `frontend/miniapp/tests/language.spec.ts`

**Step 1: Write the failing test**

Create `frontend/miniapp/tests/language.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import LanguagePage from '@/pages/settings/language.vue'

describe('LanguagePage', () => {
  it('exists', () => {
    expect(LanguagePage).toBeTruthy()
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/miniapp && pnpm vitest run tests/language.spec.ts`
Expected: FAIL

**Step 3: Write minimal implementation**

Create `frontend/miniapp/pages/settings/language.vue`:

```vue
<script setup lang="ts">
const locale = ref('zh-CN')
</script>

<template>
  <view>
    <text>Language</text>
    <picker :value="locale" :range="['zh-CN','zh-TW','en']"></picker>
  </view>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/miniapp && pnpm vitest run tests/language.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/miniapp/pages/settings/language.vue frontend/miniapp/tests/language.spec.ts
git commit -m "feat: add miniapp language settings"
```

---

## Part E: CI (Task 8)

### Task 8: i18n Coverage Gate

**Files:**
- Modify: `.github/workflows/admin.yml`
- Modify: `.github/workflows/web.yml`
- Modify: `.github/workflows/miniapp.yml`

**Step 1: Write the failing test**

Create `scripts/verify_i18n_ci_test.go`:

```go
package scripts

import (
    "os"
    "testing"
)

func TestI18nWorkflowsExist(t *testing.T) {
    files := []string{
        ".github/workflows/admin.yml",
        ".github/workflows/web.yml",
        ".github/workflows/miniapp.yml",
    }
    for _, f := range files {
        if _, err := os.Stat(f); err != nil { t.Fatalf("expected %s", f) }
    }
}
```

**Step 2: Run test to verify it fails**

Run: `go test ./scripts -run TestI18nWorkflowsExist -v`
Expected: FAIL

**Step 3: Write minimal implementation**

Ensure workflows run `pnpm vitest run --coverage` and Playwright for i18n pages.

**Step 4: Run test to verify it passes**

Run: `go test ./scripts -run TestI18nWorkflowsExist -v`
Expected: PASS

**Step 5: Commit**

```bash
git add .github/workflows scripts/verify_i18n_ci_test.go
git commit -m "chore: enforce i18n coverage in CI"
```

---

## Final Verification

Run:

```bash
cd backend && go test ./... -coverprofile=coverage.out -covermode=atomic -v
cd frontend/admin && pnpm vitest run --coverage && pnpm playwright test
cd frontend/web && pnpm vitest run --coverage && pnpm playwright test
cd frontend/miniapp && pnpm vitest run --coverage
```

Expected: All tests pass and coverage is 100%.
