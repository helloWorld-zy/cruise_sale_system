# Sprint 9: 社交分享 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 实现行程海报生成、分享链接/二维码、邀请奖励的端到端闭环（后台配置 + 前台/小程序分享）。

**Architecture:** 后端新增海报模板与邀请奖励领域模型，提供分享与邀请API；后台管理模板与奖励规则；Web与小程序展示海报与邀请链接。全流程TDD，最小实现驱动。

**Tech Stack:** Go 1.26, Gin, GORM, PostgreSQL, Nuxt 4 (admin/web), Vue 3, Pinia, Vitest, Playwright, uni-app.

---

## Part A: Backend (Tasks 1-4)

### Task 1: 分享海报与邀请领域模型

**Files:**
- Create: `backend/internal/domain/poster_template.go`
- Create: `backend/internal/domain/invite_rule.go`
- Create: `backend/internal/domain/invite.go`
- Test: `backend/internal/domain/share_domain_test.go`

**Step 1: Write the failing test**

Create `backend/internal/domain/share_domain_test.go`:

```go
package domain

import "testing"

func TestPosterTemplateModel(t *testing.T) {
    p := PosterTemplate{Name: "Classic", Status: 1}
    if p.Name == "" || p.Status != 1 {
        t.Fatal("expected poster template fields")
    }
}

func TestInviteRuleModel(t *testing.T) {
    r := InviteRule{RewardType: "coupon", RewardValue: 50}
    if r.RewardType == "" || r.RewardValue == 0 {
        t.Fatal("expected invite rule fields")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/domain -run TestPosterTemplateModel -v`
Expected: FAIL with "undefined: PosterTemplate"

**Step 3: Write minimal implementation**

Create `backend/internal/domain/poster_template.go`:

```go
package domain

import "time"

type PosterTemplate struct {
    ID int64 `gorm:"primaryKey"`
    Name string `gorm:"size:100"`
    CoverURL string `gorm:"size:500"`
    JsonSchema string `gorm:"type:text"`
    Status int16 `gorm:"default:1"`
    CreatedAt time.Time
    UpdatedAt time.Time
}
```

Create `backend/internal/domain/invite_rule.go`:

```go
package domain

import "time"

type InviteRule struct {
    ID int64 `gorm:"primaryKey"`
    RewardType string `gorm:"size:30"` // coupon, cash, points
    RewardValue int64
    MaxInvites int
    Status int16 `gorm:"default:1"`
    CreatedAt time.Time
    UpdatedAt time.Time
}
```

Create `backend/internal/domain/invite.go`:

```go
package domain

import "time"

type Invite struct {
    ID int64 `gorm:"primaryKey"`
    InviterUserID int64
    InviteeUserID int64
    Code string `gorm:"size:50;uniqueIndex"`
    Status int16 `gorm:"default:0"` // 0 pending, 1 accepted
    CreatedAt time.Time
    UpdatedAt time.Time
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/domain -run TestPosterTemplateModel -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/domain/poster_template.go backend/internal/domain/invite_rule.go backend/internal/domain/invite.go backend/internal/domain/share_domain_test.go
git commit -m "feat: add share poster and invite domain models"
```

---

### Task 2: Poster/Invite Repositories

**Files:**
- Create: `backend/internal/repository/poster_repo.go`
- Create: `backend/internal/repository/invite_repo.go`
- Test: `backend/internal/repository/share_repo_test.go`

**Step 1: Write the failing test**

Create `backend/internal/repository/share_repo_test.go`:

```go
package repository

import (
    "testing"

    "github.com/cruisebooking/backend/internal/domain"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

func TestPosterRepoCreate(t *testing.T) {
    db, _ := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    _ = db.AutoMigrate(&domain.PosterTemplate{})
    repo := NewPosterRepository(db)
    err := repo.Create(&domain.PosterTemplate{Name: "Classic"})
    if err != nil {
        t.Fatal(err)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/repository -run TestPosterRepoCreate -v`
Expected: FAIL with "undefined: NewPosterRepository"

**Step 3: Write minimal implementation**

Create `backend/internal/repository/poster_repo.go`:

```go
package repository

import (
    "github.com/cruisebooking/backend/internal/domain"
    "gorm.io/gorm"
)

type PosterRepository struct{ db *gorm.DB }

func NewPosterRepository(db *gorm.DB) *PosterRepository { return &PosterRepository{db: db} }

func (r *PosterRepository) Create(p *domain.PosterTemplate) error { return r.db.Create(p).Error }

func (r *PosterRepository) List() ([]domain.PosterTemplate, error) {
    var items []domain.PosterTemplate
    return items, r.db.Order("id desc").Find(&items).Error
}
```

Create `backend/internal/repository/invite_repo.go`:

```go
package repository

import (
    "github.com/cruisebooking/backend/internal/domain"
    "gorm.io/gorm"
)

type InviteRepository struct{ db *gorm.DB }

func NewInviteRepository(db *gorm.DB) *InviteRepository { return &InviteRepository{db: db} }

func (r *InviteRepository) Create(i *domain.Invite) error { return r.db.Create(i).Error }

func (r *InviteRepository) GetByCode(code string) (*domain.Invite, error) {
    var inv domain.Invite
    if err := r.db.Where("code = ?", code).First(&inv).Error; err != nil {
        return nil, err
    }
    return &inv, nil
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/repository -run TestPosterRepoCreate -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/repository/poster_repo.go backend/internal/repository/invite_repo.go backend/internal/repository/share_repo_test.go
git commit -m "feat: add poster and invite repositories"
```

---

### Task 3: Share Service (Poster + Invite)

**Files:**
- Create: `backend/internal/service/share_service.go`
- Test: `backend/internal/service/share_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/share_service_test.go`:

```go
package service

import "testing"

type fakePosterRepo struct{}
func (fakePosterRepo) List() ([]PosterTemplateDTO, error) { return []PosterTemplateDTO{{ID: 1, Name: "Classic"}}, nil }

func TestBuildInviteLink(t *testing.T) {
    svc := NewShareService(fakePosterRepo{})
    link := svc.BuildInviteLink("ABC123")
    if link == "" {
        t.Fatal("expected link")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestBuildInviteLink -v`
Expected: FAIL with "undefined: NewShareService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/share_service.go`:

```go
package service

import "fmt"

type PosterTemplateDTO struct {
    ID int64
    Name string
}

type PosterRepo interface {
    List() ([]PosterTemplateDTO, error)
}

type ShareService struct{ posterRepo PosterRepo }

func NewShareService(repo PosterRepo) *ShareService { return &ShareService{posterRepo: repo} }

func (s *ShareService) BuildInviteLink(code string) string {
    return fmt.Sprintf("/share/invite/%s", code)
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestBuildInviteLink -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/share_service.go backend/internal/service/share_service_test.go
git commit -m "feat: add share service for invite links"
```

---

### Task 4: Share API Handlers

**Files:**
- Create: `backend/internal/handler/share_handler.go`
- Test: `backend/internal/handler/share_handler_test.go`

**Step 1: Write the failing test**

Create `backend/internal/handler/share_handler_test.go`:

```go
package handler

import (
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/gin-gonic/gin"
)

type fakeShareSvc struct{}
func (fakeShareSvc) BuildInviteLink(code string) string { return "/share/invite/" + code }

func TestInviteLinkEndpoint(t *testing.T) {
    r := gin.New()
    h := NewShareHandler(fakeShareSvc{})
    r.GET("/share/invite-link", h.InviteLink)
    w := httptest.NewRecorder()
    r.ServeHTTP(w, httptest.NewRequest("GET", "/share/invite-link?code=ABC", nil))
    if w.Code != http.StatusOK {
        t.Fatalf("expected 200, got %d", w.Code)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/handler -run TestInviteLinkEndpoint -v`
Expected: FAIL with "undefined: NewShareHandler"

**Step 3: Write minimal implementation**

Create `backend/internal/handler/share_handler.go`:

```go
package handler

import "github.com/gin-gonic/gin"

type ShareService interface {
    BuildInviteLink(code string) string
}

type ShareHandler struct{ svc ShareService }

func NewShareHandler(svc ShareService) *ShareHandler { return &ShareHandler{svc: svc} }

func (h *ShareHandler) InviteLink(c *gin.Context) {
    code := c.Query("code")
    c.JSON(200, gin.H{"link": h.svc.BuildInviteLink(code)})
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/handler -run TestInviteLinkEndpoint -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/handler/share_handler.go backend/internal/handler/share_handler_test.go
git commit -m "feat: add share handler endpoints"
```

---

## Part B: Admin (Tasks 5-6)

> Follow @vue-best-practices and @vue-testing-best-practices.

### Task 5: 海报模板列表页面

**Files:**
- Create: `frontend/admin/pages/marketing/posters.vue`
- Create: `frontend/admin/composables/usePosters.ts`
- Test: `frontend/admin/tests/unit/marketing/posters.spec.ts`

**Step 1: Write the failing test**

Create `frontend/admin/tests/unit/marketing/posters.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import PostersPage from '@/pages/marketing/posters.vue'

describe('PostersPage', () => {
  it('renders title', () => {
    const wrapper = mount(PostersPage)
    expect(wrapper.text()).toContain('Poster Templates')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/admin && pnpm vitest run tests/unit/marketing/posters.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/admin/composables/usePosters.ts`:

```ts
export interface PosterTemplate {
  id: number
  name: string
  status: number
}

export const usePosters = () => {
  const items = ref<PosterTemplate[]>([])
  const fetchAll = async () => {
    items.value = [{ id: 1, name: 'Classic', status: 1 }]
  }
  return { items, fetchAll }
}
```

Create `frontend/admin/pages/marketing/posters.vue`:

```vue
<script setup lang="ts">
import { usePosters } from '@/composables/usePosters'

const { items, fetchAll } = usePosters()
onMounted(fetchAll)
</script>

<template>
  <section>
    <h1>Poster Templates</h1>
    <ul>
      <li v-for="p in items" :key="p.id">{{ p.name }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/admin && pnpm vitest run tests/unit/marketing/posters.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/admin/pages/marketing/posters.vue frontend/admin/composables/usePosters.ts frontend/admin/tests/unit/marketing/posters.spec.ts
git commit -m "feat: add poster templates admin page"
```

---

### Task 6: 邀请奖励规则配置页面

**Files:**
- Create: `frontend/admin/pages/marketing/invite-rules.vue`
- Test: `frontend/admin/tests/unit/marketing/invite-rules.spec.ts`

**Step 1: Write the failing test**

Create `frontend/admin/tests/unit/marketing/invite-rules.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import InviteRulesPage from '@/pages/marketing/invite-rules.vue'

describe('InviteRulesPage', () => {
  it('renders rule form', () => {
    const wrapper = mount(InviteRulesPage)
    expect(wrapper.text()).toContain('Invite Reward')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/admin && pnpm vitest run tests/unit/marketing/invite-rules.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/admin/pages/marketing/invite-rules.vue`:

```vue
<script setup lang="ts">
const rewardType = ref('coupon')
const rewardValue = ref(50)
</script>

<template>
  <section>
    <h1>Invite Reward</h1>
    <label>Type</label>
    <select v-model="rewardType">
      <option value="coupon">Coupon</option>
      <option value="cash">Cash</option>
    </select>
    <label>Value</label>
    <input v-model="rewardValue" type="number" />
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/admin && pnpm vitest run tests/unit/marketing/invite-rules.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/admin/pages/marketing/invite-rules.vue frontend/admin/tests/unit/marketing/invite-rules.spec.ts
git commit -m "feat: add invite reward rule config page"
```

---

## Part C: Web (Task 7)

### Task 7: 分享海报页面

**Files:**
- Create: `frontend/web/pages/share/[code].vue`
- Test: `frontend/web/tests/unit/share.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/share.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import SharePage from '@/pages/share/[code].vue'

describe('SharePage', () => {
  it('renders invite title', () => {
    const wrapper = mount(SharePage, { props: { code: 'ABC' } })
    expect(wrapper.text()).toContain('Invite Code')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/share.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/web/pages/share/[code].vue`:

```vue
<script setup lang="ts">
const route = useRoute()
const code = computed(() => String(route.params.code || ''))
</script>

<template>
  <section>
    <h1>Invite Code</h1>
    <p>{{ code }}</p>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/share.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/pages/share/[code].vue frontend/web/tests/unit/share.spec.ts
git commit -m "feat: add share invite page"
```

---

## Part D: Miniapp (Task 8)

### Task 8: 小程序分享页

**Files:**
- Create: `frontend/miniapp/pages/share/share.vue`
- Test: `frontend/miniapp/tests/share.spec.ts`

**Step 1: Write the failing test**

Create `frontend/miniapp/tests/share.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import SharePage from '@/pages/share/share.vue'

describe('Miniapp SharePage', () => {
  it('has share title', () => {
    expect(SharePage).toBeTruthy()
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/miniapp && pnpm vitest run tests/share.spec.ts`
Expected: FAIL (file missing)

**Step 3: Write minimal implementation**

Create `frontend/miniapp/pages/share/share.vue`:

```vue
<script setup lang="ts">
const code = ref('')
</script>

<template>
  <view>
    <text>Invite Code</text>
    <text>{{ code }}</text>
  </view>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/miniapp && pnpm vitest run tests/share.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/miniapp/pages/share/share.vue frontend/miniapp/tests/share.spec.ts
git commit -m "feat: add miniapp share page"
```

---

## Part E: CI (Task 9)

### Task 9: CI Coverage Gate for Share Modules

**Files:**
- Modify: `.github/workflows/backend.yml`
- Modify: `.github/workflows/admin.yml`
- Modify: `.github/workflows/web.yml`
- Modify: `.github/workflows/miniapp.yml`

**Step 1: Write the failing test**

Create `scripts/verify_share_ci_test.go`:

```go
package scripts

import (
    "os"
    "testing"
)

func TestShareCIWorkflowsExist(t *testing.T) {
    files := []string{
        ".github/workflows/backend.yml",
        ".github/workflows/admin.yml",
        ".github/workflows/web.yml",
        ".github/workflows/miniapp.yml",
    }
    for _, f := range files {
        if _, err := os.Stat(f); err != nil {
            t.Fatalf("expected %s to exist", f)
        }
    }
}
```

**Step 2: Run test to verify it fails**

Run: `go test ./scripts -run TestShareCIWorkflowsExist -v`
Expected: FAIL (files missing or not updated)

**Step 3: Write minimal implementation**

Update workflow steps to include coverage checks for new modules (ensure coverage thresholds are 100%). Example snippet for `backend.yml`:

```yaml
- name: Test
  run: go test ./... -coverprofile=coverage.out -covermode=atomic -v
```

**Step 4: Run test to verify it passes**

Run: `go test ./scripts -run TestShareCIWorkflowsExist -v`
Expected: PASS

**Step 5: Commit**

```bash
git add .github/workflows scripts/verify_share_ci_test.go
git commit -m "chore: enforce share coverage in CI"
```

---

## Final Verification

Run:

```bash
cd backend && go test ./... -coverprofile=coverage.out -covermode=atomic -v
cd frontend/admin && pnpm vitest run --coverage && pnpm playwright test
cd frontend/web && pnpm vitest run --coverage && pnpm playwright test
cd frontend/miniapp && pnpm vitest run --coverage
```

Expected: All tests pass and coverage is 100%.
