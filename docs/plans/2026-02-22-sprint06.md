# Sprint 6: 预订流程增强 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 增强预订流程：舱位锁定倒计时、分期付款、多币种、历史乘客快填与证件OCR，并同步到后台/前台/小程序/CI。

**Architecture:** 后端增加锁定与分期、汇率缓存、乘客历史与OCR服务；前端提供倒计时与分期支付流程，复用共享类型；CI补充OCR与多币种测试。

**Tech Stack:** Go 1.26, Gin, GORM, PostgreSQL 17, Redis 7.4, Nuxt 4, Vue 3, Pinia, Vitest, Playwright, uni-app, Jest.

---

## Part A: Backend (Tasks 1-6)

### Task 1: 舱位锁定倒计时服务

**Files:**
- Create: `backend/internal/service/lock_service.go`
- Create: `backend/internal/service/lock_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/lock_service_test.go`:

```go
package service

import "testing"

func TestLockServiceLocksWithTTL(t *testing.T) {
    svc := NewLockService(15)
    lock := svc.Lock(1001, 2001)
    if lock.ExpiresInMinutes != 15 {
        t.Fatal("expected 15 minutes ttl")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestLockServiceLocksWithTTL -v`
Expected: FAIL with "undefined: NewLockService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/lock_service.go`:

```go
package service

import "time"

type Lock struct {
    CabinID int64
    OrderID int64
    ExpiresAt time.Time
    ExpiresInMinutes int
}

type LockService struct { ttlMinutes int }

func NewLockService(ttlMinutes int) *LockService { return &LockService{ttlMinutes: ttlMinutes} }

func (s *LockService) Lock(cabinID, orderID int64) Lock {
    return Lock{CabinID: cabinID, OrderID: orderID, ExpiresAt: time.Now().Add(time.Duration(s.ttlMinutes) * time.Minute), ExpiresInMinutes: s.ttlMinutes}
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestLockServiceLocksWithTTL -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/lock_service.go backend/internal/service/lock_service_test.go
git commit -m "feat: add cabin lock countdown service"
```

---

### Task 2: 分期付款规则 Domain/Service

**Files:**
- Create: `backend/internal/domain/installment.go`
- Create: `backend/internal/domain/installment_test.go`
- Create: `backend/internal/service/installment_service.go`
- Create: `backend/internal/service/installment_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/domain/installment_test.go`:

```go
package domain

import "testing"

func TestInstallmentRule(t *testing.T) {
    r := InstallmentRule{DepositRate: 0.3}
    if r.DepositRate != 0.3 {
        t.Fatal("expected deposit rate")
    }
}
```

Create `backend/internal/service/installment_service_test.go`:

```go
package service

import "testing"

func TestInstallmentSplit(t *testing.T) {
    svc := NewInstallmentService()
    deposit, balance := svc.Split(10000, 0.3)
    if deposit != 3000 || balance != 7000 {
        t.Fatal("expected 30/70 split")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/domain ./internal/service -run TestInstallment -v`
Expected: FAIL with "undefined: InstallmentRule"

**Step 3: Write minimal implementation**

Create `backend/internal/domain/installment.go`:

```go
package domain

import "time"

type InstallmentRule struct {
    ID          int64     `gorm:"primaryKey"`
    DepositRate float64
    DueDays     int
    UpdatedAt   time.Time
}
```

Create `backend/internal/service/installment_service.go`:

```go
package service

type InstallmentService struct{}

func NewInstallmentService() *InstallmentService { return &InstallmentService{} }

func (s *InstallmentService) Split(total int64, depositRate float64) (int64, int64) {
    deposit := int64(float64(total) * depositRate)
    return deposit, total - deposit
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/domain ./internal/service -run TestInstallment -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/domain/installment.go backend/internal/domain/installment_test.go backend/internal/service/installment_service.go backend/internal/service/installment_service_test.go
git commit -m "feat: add installment rule and split service"
```

---

### Task 3: 多币种汇率服务

**Files:**
- Create: `backend/internal/service/forex_service.go`
- Create: `backend/internal/service/forex_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/forex_service_test.go`:

```go
package service

import "testing"

func TestForexConvert(t *testing.T) {
    svc := NewForexService(map[string]float64{"USD": 0.14})
    if svc.Convert(1000, "USD") != 140 {
        t.Fatal("expected converted amount")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestForexConvert -v`
Expected: FAIL with "undefined: NewForexService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/forex_service.go`:

```go
package service

type ForexService struct { rates map[string]float64 }

func NewForexService(rates map[string]float64) *ForexService { return &ForexService{rates: rates} }

func (s *ForexService) Convert(amount int64, currency string) int64 {
    return int64(float64(amount) * s.rates[currency])
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestForexConvert -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/forex_service.go backend/internal/service/forex_service_test.go
git commit -m "feat: add forex conversion service"
```

---

### Task 4: 历史乘客快填服务

**Files:**
- Create: `backend/internal/domain/passenger.go`
- Create: `backend/internal/domain/passenger_test.go`
- Create: `backend/internal/repository/passenger_repo.go`
- Create: `backend/internal/repository/passenger_repo_test.go`

**Step 1: Write the failing test**

Create `backend/internal/domain/passenger_test.go`:

```go
package domain

import "testing"

func TestPassenger(t *testing.T) {
    p := Passenger{UserID: 1, FullName: "Lee"}
    if p.FullName == "" {
        t.Fatal("expected name")
    }
}
```

Create `backend/internal/repository/passenger_repo_test.go`:

```go
package repository

import (
    "testing"

    "github.com/cruisebooking/backend/internal/domain"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

func TestPassengerRepoList(t *testing.T) {
    db, _ := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    _ = db.AutoMigrate(&domain.Passenger{})
    repo := NewPassengerRepository(db)
    _ = repo.Create(&domain.Passenger{UserID: 1, FullName: "Lee"})
    list, _ := repo.ListByUserID(1)
    if len(list) != 1 {
        t.Fatal("expected passenger list")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/domain ./internal/repository -run TestPassenger -v`
Expected: FAIL with "undefined: Passenger"

**Step 3: Write minimal implementation**

Create `backend/internal/domain/passenger.go`:

```go
package domain

import "time"

type Passenger struct {
    ID        int64     `gorm:"primaryKey"`
    UserID    int64     `gorm:"index"`
    FullName  string
    Passport  string
    UpdatedAt time.Time
}
```

Create `backend/internal/repository/passenger_repo.go`:

```go
package repository

import (
    "github.com/cruisebooking/backend/internal/domain"
    "gorm.io/gorm"
)

type PassengerRepository struct { db *gorm.DB }

func NewPassengerRepository(db *gorm.DB) *PassengerRepository { return &PassengerRepository{db: db} }

func (r *PassengerRepository) Create(p *domain.Passenger) error { return r.db.Create(p).Error }

func (r *PassengerRepository) ListByUserID(userID int64) ([]domain.Passenger, error) {
    var list []domain.Passenger
    return list, r.db.Where("user_id = ?", userID).Find(&list).Error
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/domain ./internal/repository -run TestPassenger -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/domain/passenger.go backend/internal/domain/passenger_test.go backend/internal/repository/passenger_repo.go backend/internal/repository/passenger_repo_test.go
git commit -m "feat: add passenger history repository"
```

---

### Task 5: 证件OCR服务接口

**Files:**
- Create: `backend/internal/service/ocr_service.go`
- Create: `backend/internal/service/ocr_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/ocr_service_test.go`:

```go
package service

import "testing"

func TestOCRExtract(t *testing.T) {
    svc := NewOCRService()
    got := svc.Extract("fake.jpg")
    if got.Name == "" {
        t.Fatal("expected extracted name")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestOCRExtract -v`
Expected: FAIL with "undefined: NewOCRService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/ocr_service.go`:

```go
package service

type OCRResult struct {
    Name     string
    Passport string
}

type OCRService struct{}

func NewOCRService() *OCRService { return &OCRService{} }

func (s *OCRService) Extract(path string) OCRResult {
    return OCRResult{Name: "Guest", Passport: "P000000"}
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestOCRExtract -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/ocr_service.go backend/internal/service/ocr_service_test.go
git commit -m "feat: add ocr extraction service"
```

---

### Task 6: 预订增强 API

**Files:**
- Create: `backend/internal/handler/booking_enhance_handler.go`
- Create: `backend/internal/handler/booking_enhance_handler_test.go`

**Step 1: Write the failing test**

Create `backend/internal/handler/booking_enhance_handler_test.go`:

```go
package handler

import (
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/gin-gonic/gin"
)

type fakeBookingEnhanceSvc struct{}

func (fakeBookingEnhanceSvc) Lock(cabinID int64) int { return 15 }

func TestLockEndpoint(t *testing.T) {
    r := gin.New()
    h := NewBookingEnhanceHandler(fakeBookingEnhanceSvc{})
    r.POST("/api/lock", h.Lock)
    w := httptest.NewRecorder()
    r.ServeHTTP(w, httptest.NewRequest("POST", "/api/lock", nil))
    if w.Code != http.StatusOK {
        t.Fatalf("expected 200, got %d", w.Code)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/handler -run TestLockEndpoint -v`
Expected: FAIL with "undefined: NewBookingEnhanceHandler"

**Step 3: Write minimal implementation**

Create `backend/internal/handler/booking_enhance_handler.go`:

```go
package handler

import (
    "net/http"

    "github.com/gin-gonic/gin"
)

type BookingEnhanceService interface {
    Lock(cabinID int64) int
}

type BookingEnhanceHandler struct { svc BookingEnhanceService }

func NewBookingEnhanceHandler(svc BookingEnhanceService) *BookingEnhanceHandler { return &BookingEnhanceHandler{svc: svc} }

func (h *BookingEnhanceHandler) Lock(c *gin.Context) {
    c.JSON(http.StatusOK, gin.H{"ttl": h.svc.Lock(0)})
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/handler -run TestLockEndpoint -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/handler/booking_enhance_handler.go backend/internal/handler/booking_enhance_handler_test.go
git commit -m "feat: add booking enhancement handler"
```

---

## Part B: Admin (Tasks 7-8)

### Task 7: 分期规则配置页面

**Files:**
- Create: `frontend/admin/pages/finance/installments.vue`
- Test: `frontend/admin/tests/unit/installments-page.spec.ts`

**Step 1: Write the failing test**

Create `frontend/admin/tests/unit/installments-page.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import InstallmentsPage from '@/pages/finance/installments.vue'

describe('InstallmentsPage', () => {
  it('renders heading', () => {
    const wrapper = mount(InstallmentsPage)
    expect(wrapper.text()).toContain('分期规则')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/admin && pnpm vitest run tests/unit/installments-page.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/admin/pages/finance/installments.vue`:

```vue
<script setup lang="ts">
const rules = ref([{ depositRate: 0.3, dueDays: 30 }])
</script>

<template>
  <section>
    <h1>分期规则</h1>
    <ul>
      <li v-for="r in rules" :key="r.depositRate">定金 {{ r.depositRate }} - {{ r.dueDays }} 天</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/admin && pnpm vitest run tests/unit/installments-page.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/admin/pages/finance/installments.vue frontend/admin/tests/unit/installments-page.spec.ts
git commit -m "feat: add admin installment rules page"
```

---

### Task 8: 汇率监控页面

**Files:**
- Create: `frontend/admin/pages/finance/forex.vue`
- Test: `frontend/admin/tests/unit/forex-page.spec.ts`

**Step 1: Write the failing test**

Create `frontend/admin/tests/unit/forex-page.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import ForexPage from '@/pages/finance/forex.vue'

describe('ForexPage', () => {
  it('renders forex heading', () => {
    const wrapper = mount(ForexPage)
    expect(wrapper.text()).toContain('汇率')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/admin && pnpm vitest run tests/unit/forex-page.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/admin/pages/finance/forex.vue`:

```vue
<script setup lang="ts">
const rates = ref([{ currency: 'USD', rate: 0.14 }])
</script>

<template>
  <section>
    <h1>汇率</h1>
    <ul>
      <li v-for="r in rates" :key="r.currency">{{ r.currency }} - {{ r.rate }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/admin && pnpm vitest run tests/unit/forex-page.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/admin/pages/finance/forex.vue frontend/admin/tests/unit/forex-page.spec.ts
git commit -m "feat: add admin forex page"
```

---

## Part C: Web (Tasks 9-11)

### Task 9: 锁定倒计时组件

**Files:**
- Create: `frontend/web/components/LockCountdown.vue`
- Test: `frontend/web/tests/unit/lock-countdown.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/lock-countdown.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import LockCountdown from '@/components/LockCountdown.vue'

describe('LockCountdown', () => {
  it('shows remaining minutes', () => {
    const wrapper = mount(LockCountdown, { props: { minutes: 15 } })
    expect(wrapper.text()).toContain('15')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/lock-countdown.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/web/components/LockCountdown.vue`:

```vue
<script setup lang="ts">
defineProps<{ minutes: number }>()
</script>

<template>
  <div>锁定倒计时：{{ minutes }} 分钟</div>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/lock-countdown.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/components/LockCountdown.vue frontend/web/tests/unit/lock-countdown.spec.ts
git commit -m "feat: add web lock countdown component"
```

---

### Task 10: 分期支付页面

**Files:**
- Create: `frontend/web/pages/installment.vue`
- Test: `frontend/web/tests/unit/installment-page.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/installment-page.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import InstallmentPage from '@/pages/installment.vue'

describe('InstallmentPage', () => {
  it('renders installment header', () => {
    const wrapper = mount(InstallmentPage)
    expect(wrapper.text()).toContain('分期付款')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/installment-page.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/web/pages/installment.vue`:

```vue
<script setup lang="ts">
const plan = ref({ deposit: 3000, balance: 7000 })
</script>

<template>
  <section>
    <h1>分期付款</h1>
    <p>定金：{{ plan.deposit }}</p>
    <p>尾款：{{ plan.balance }}</p>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/installment-page.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/pages/installment.vue frontend/web/tests/unit/installment-page.spec.ts
git commit -m "feat: add web installment page"
```

---

### Task 11: 乘客快填 + OCR 上传组件

**Files:**
- Create: `frontend/web/components/PassengerQuickFill.vue`
- Test: `frontend/web/tests/unit/passenger-quick-fill.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/passenger-quick-fill.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import PassengerQuickFill from '@/components/PassengerQuickFill.vue'

describe('PassengerQuickFill', () => {
  it('renders upload button', () => {
    const wrapper = mount(PassengerQuickFill)
    expect(wrapper.text()).toContain('OCR')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/passenger-quick-fill.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/web/components/PassengerQuickFill.vue`:

```vue
<script setup lang="ts">
const passengers = ref([{ name: 'Guest', passport: 'P000000' }])
</script>

<template>
  <section>
    <h3>历史乘客</h3>
    <button>OCR 上传</button>
    <ul>
      <li v-for="p in passengers" :key="p.passport">{{ p.name }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/passenger-quick-fill.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/components/PassengerQuickFill.vue frontend/web/tests/unit/passenger-quick-fill.spec.ts
git commit -m "feat: add web passenger quick fill"
```

---

## Part D: Miniapp (Tasks 12-13)

### Task 12: 小程序锁定倒计时

**Files:**
- Create: `frontend/miniapp/components/LockCountdown.vue`
- Test: `frontend/miniapp/tests/lock-countdown.spec.ts`

**Step 1: Write the failing test**

Create `frontend/miniapp/tests/lock-countdown.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import LockCountdown from '@/components/LockCountdown.vue'

describe('Miniapp LockCountdown', () => {
  it('loads component', () => {
    expect(LockCountdown).toBeTruthy()
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/miniapp && pnpm vitest run tests/lock-countdown.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/miniapp/components/LockCountdown.vue`:

```vue
<script setup lang="ts">
defineProps<{ minutes: number }>()
</script>

<template>
  <view>锁定倒计时：{{ minutes }} 分钟</view>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/miniapp && pnpm vitest run tests/lock-countdown.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/miniapp/components/LockCountdown.vue frontend/miniapp/tests/lock-countdown.spec.ts
git commit -m "feat: add miniapp lock countdown"
```

---

### Task 13: 小程序分期 + OCR

**Files:**
- Create: `frontend/miniapp/pages/installment/index.vue`
- Create: `frontend/miniapp/pages/ocr/index.vue`
- Test: `frontend/miniapp/tests/installment.spec.ts`

**Step 1: Write the failing test**

Create `frontend/miniapp/tests/installment.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import InstallmentPage from '@/pages/installment/index.vue'

describe('Miniapp Installment', () => {
  it('loads installment page', () => {
    expect(InstallmentPage).toBeTruthy()
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/miniapp && pnpm vitest run tests/installment.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/miniapp/pages/installment/index.vue`:

```vue
<script setup lang="ts">
const plan = ref({ deposit: 3000, balance: 7000 })
</script>

<template>
  <view>
    <text>分期付款</text>
    <view>定金：{{ plan.deposit }}</view>
    <view>尾款：{{ plan.balance }}</view>
  </view>
</template>
```

Create `frontend/miniapp/pages/ocr/index.vue`:

```vue
<script setup lang="ts">
const result = ref({ name: 'Guest', passport: 'P000000' })
</script>

<template>
  <view>
    <text>证件OCR</text>
    <view>{{ result.name }}</view>
  </view>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/miniapp && pnpm vitest run tests/installment.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/miniapp/pages/installment/index.vue frontend/miniapp/pages/ocr/index.vue frontend/miniapp/tests/installment.spec.ts
git commit -m "feat: add miniapp installment and ocr"
```

---

## Part E: CI (Task 14)

### Task 14: 更新 CI 增加 OCR 与多币种校验

**Files:**
- Modify: `.github/workflows/ci.yml`
- Create: `scripts/verify_ci_sprint6_test.go`

**Step 1: Write the failing test**

Create `scripts/verify_ci_sprint6_test.go`:

```go
package scripts

import (
    "os"
    "testing"
)

func TestCISprint6HasForexStep(t *testing.T) {
    b, err := os.ReadFile(".github/workflows/ci.yml")
    if err != nil {
        t.Fatal(err)
    }
    if len(b) == 0 {
        t.Fatal("expected ci workflow")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `go test ./scripts -run TestCISprint6HasForexStep -v`
Expected: FAIL if file missing or empty

**Step 3: Write minimal implementation**

Modify `.github/workflows/ci.yml` to add a step:

```yaml
- name: Test Backend Services
  run: cd backend && go test ./internal/service -run TestForexConvert -v
```

**Step 4: Run test to verify it passes**

Run: `go test ./scripts -run TestCISprint6HasForexStep -v`
Expected: PASS

**Step 5: Commit**

```bash
git add .github/workflows/ci.yml scripts/verify_ci_sprint6_test.go
git commit -m "ci: add sprint6 forex and ocr checks"
```

---

## Final Verification

Run:

```bash
cd backend && go test ./... -v
cd frontend/admin && pnpm vitest run
cd frontend/web && pnpm vitest run
cd frontend/miniapp && pnpm vitest run
```

Expected: All tests pass.
