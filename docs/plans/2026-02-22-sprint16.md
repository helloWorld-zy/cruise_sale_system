# Sprint 16: 上线部署 + 监控 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 完成 Kubernetes 部署、监控与日志方案，并提供运维手册与状态展示。

**Architecture:** 基础设施使用 K8s + Prometheus + Grafana + Loki；后端提供指标端点；前端提供状态页面；CI增加清单校验。TDD驱动。

**Tech Stack:** Go 1.26, Gin, Kubernetes, Prometheus, Grafana, Loki, Nuxt 4 (admin/web), Vue 3, Vitest, Playwright, uni-app.

---

## Part A: Backend/Infra (Tasks 1-4)

### Task 1: Prometheus Metrics 端点

**Files:**
- Create: `backend/internal/handler/metrics_handler.go`
- Test: `backend/internal/handler/metrics_handler_test.go`

**Step 1: Write the failing test**

Create `backend/internal/handler/metrics_handler_test.go`:

```go
package handler

import (
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/gin-gonic/gin"
)

func TestMetricsAPI(t *testing.T) {
    r := gin.New()
    h := NewMetricsHandler()
    r.GET("/metrics", h.Metrics)
    w := httptest.NewRecorder()
    r.ServeHTTP(w, httptest.NewRequest("GET", "/metrics", nil))
    if w.Code != http.StatusOK { t.Fatalf("expected 200, got %d", w.Code) }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/handler -run TestMetricsAPI -v`
Expected: FAIL

**Step 3: Write minimal implementation**

Create `backend/internal/handler/metrics_handler.go`:

```go
package handler

import "github.com/gin-gonic/gin"

type MetricsHandler struct{}

func NewMetricsHandler() *MetricsHandler { return &MetricsHandler{} }

func (h *MetricsHandler) Metrics(c *gin.Context) { c.String(200, "# HELP up 1\n# TYPE up gauge\nup 1\n") }
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/handler -run TestMetricsAPI -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/handler/metrics_handler.go backend/internal/handler/metrics_handler_test.go
git commit -m "feat: add prometheus metrics handler"
```

---

### Task 2: Kubernetes 部署清单

**Files:**
- Create: `deploy/k8s/backend-deployment.yaml`
- Create: `deploy/k8s/backend-service.yaml`
- Create: `deploy/k8s/ingress.yaml`
- Test: `deploy/k8s/k8s_manifests_test.go`

**Step 1: Write the failing test**

Create `deploy/k8s/k8s_manifests_test.go`:

```go
package k8s

import (
    "os"
    "testing"
)

func TestK8sManifestsExist(t *testing.T) {
    files := []string{
        "deploy/k8s/backend-deployment.yaml",
        "deploy/k8s/backend-service.yaml",
        "deploy/k8s/ingress.yaml",
    }
    for _, f := range files {
        if _, err := os.Stat(f); err != nil { t.Fatalf("expected %s", f) }
    }
}
```

**Step 2: Run test to verify it fails**

Run: `go test ./deploy/k8s -run TestK8sManifestsExist -v`
Expected: FAIL

**Step 3: Write minimal implementation**

Create `deploy/k8s/backend-deployment.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cruise-backend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: cruise-backend
  template:
    metadata:
      labels:
        app: cruise-backend
    spec:
      containers:
        - name: backend
          image: cruise/backend:latest
          ports:
            - containerPort: 8080
```

Create `deploy/k8s/backend-service.yaml`:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: cruise-backend
spec:
  selector:
    app: cruise-backend
  ports:
    - port: 80
      targetPort: 8080
```

Create `deploy/k8s/ingress.yaml`:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cruise-ingress
spec:
  rules:
    - host: cruise.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: cruise-backend
                port:
                  number: 80
```

**Step 4: Run test to verify it passes**

Run: `go test ./deploy/k8s -run TestK8sManifestsExist -v`
Expected: PASS

**Step 5: Commit**

```bash
git add deploy/k8s/backend-deployment.yaml deploy/k8s/backend-service.yaml deploy/k8s/ingress.yaml deploy/k8s/k8s_manifests_test.go
git commit -m "chore: add k8s deployment manifests"
```

---

### Task 3: Grafana + Loki 配置文件

**Files:**
- Create: `deploy/monitoring/grafana-dashboard.json`
- Create: `deploy/monitoring/loki-config.yaml`
- Test: `deploy/monitoring/monitoring_files_test.go`

**Step 1: Write the failing test**

Create `deploy/monitoring/monitoring_files_test.go`:

```go
package monitoring

import (
    "os"
    "testing"
)

func TestMonitoringFilesExist(t *testing.T) {
    files := []string{
        "deploy/monitoring/grafana-dashboard.json",
        "deploy/monitoring/loki-config.yaml",
    }
    for _, f := range files {
        if _, err := os.Stat(f); err != nil { t.Fatalf("expected %s", f) }
    }
}
```

**Step 2: Run test to verify it fails**

Run: `go test ./deploy/monitoring -run TestMonitoringFilesExist -v`
Expected: FAIL

**Step 3: Write minimal implementation**

Create `deploy/monitoring/grafana-dashboard.json`:

```json
{
  "title": "Cruise Metrics",
  "panels": []
}
```

Create `deploy/monitoring/loki-config.yaml`:

```yaml
auth_enabled: false
server:
  http_listen_port: 3100
```

**Step 4: Run test to verify it passes**

Run: `go test ./deploy/monitoring -run TestMonitoringFilesExist -v`
Expected: PASS

**Step 5: Commit**

```bash
git add deploy/monitoring/grafana-dashboard.json deploy/monitoring/loki-config.yaml deploy/monitoring/monitoring_files_test.go
git commit -m "chore: add grafana and loki configs"
```

---

### Task 4: 运维手册

**Files:**
- Create: `docs/ops/runbook.md`
- Test: `docs/ops/runbook_test.go`

**Step 1: Write the failing test**

Create `docs/ops/runbook_test.go`:

```go
package ops

import (
    "os"
    "testing"
)

func TestRunbookExists(t *testing.T) {
    if _, err := os.Stat("docs/ops/runbook.md"); err != nil {
        t.Fatal("expected runbook")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `go test ./docs/ops -run TestRunbookExists -v`
Expected: FAIL

**Step 3: Write minimal implementation**

Create `docs/ops/runbook.md`:

```markdown
# CruiseBooking Ops Runbook

## Deploy
- Apply K8s manifests from `deploy/k8s/`

## Monitoring
- Import Grafana dashboard
- Check Loki logs
```

**Step 4: Run test to verify it passes**

Run: `go test ./docs/ops -run TestRunbookExists -v`
Expected: PASS

**Step 5: Commit**

```bash
git add docs/ops/runbook.md docs/ops/runbook_test.go
git commit -m "docs: add ops runbook"
```

---

## Part B: Admin (Task 5)

> Follow @vue-best-practices and @vue-testing-best-practices.

### Task 5: 监控入口页面

**Files:**
- Create: `frontend/admin/pages/ops/monitoring.vue`
- Test: `frontend/admin/tests/unit/ops/monitoring.spec.ts`

**Step 1: Write the failing test**

Create `frontend/admin/tests/unit/ops/monitoring.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import MonitoringPage from '@/pages/ops/monitoring.vue'

describe('MonitoringPage', () => {
  it('renders heading', () => {
    const wrapper = mount(MonitoringPage)
    expect(wrapper.text()).toContain('Monitoring')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/admin && pnpm vitest run tests/unit/ops/monitoring.spec.ts`
Expected: FAIL

**Step 3: Write minimal implementation**

Create `frontend/admin/pages/ops/monitoring.vue`:

```vue
<template>
  <section>
    <h1>Monitoring</h1>
    <a href="/grafana" target="_blank">Grafana</a>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/admin && pnpm vitest run tests/unit/ops/monitoring.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/admin/pages/ops/monitoring.vue frontend/admin/tests/unit/ops/monitoring.spec.ts
git commit -m "feat: add admin monitoring entry page"
```

---

## Part C: Web (Task 6)

### Task 6: 服务状态页面

**Files:**
- Create: `frontend/web/pages/status.vue`
- Test: `frontend/web/tests/unit/status.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/status.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import StatusPage from '@/pages/status.vue'

describe('StatusPage', () => {
  it('renders heading', () => {
    const wrapper = mount(StatusPage)
    expect(wrapper.text()).toContain('Service Status')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/status.spec.ts`
Expected: FAIL

**Step 3: Write minimal implementation**

Create `frontend/web/pages/status.vue`:

```vue
<template>
  <section>
    <h1>Service Status</h1>
    <p>All systems operational.</p>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/status.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/pages/status.vue frontend/web/tests/unit/status.spec.ts
git commit -m "feat: add service status page"
```

---

## Part D: Miniapp (Task 7)

### Task 7: 小程序维护公告

**Files:**
- Create: `frontend/miniapp/pages/status/status.vue`
- Test: `frontend/miniapp/tests/status.spec.ts`

**Step 1: Write the failing test**

Create `frontend/miniapp/tests/status.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import StatusPage from '@/pages/status/status.vue'

describe('Miniapp StatusPage', () => {
  it('exists', () => {
    expect(StatusPage).toBeTruthy()
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/miniapp && pnpm vitest run tests/status.spec.ts`
Expected: FAIL

**Step 3: Write minimal implementation**

Create `frontend/miniapp/pages/status/status.vue`:

```vue
<template>
  <view>
    <text>Service Status</text>
    <text>OK</text>
  </view>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/miniapp && pnpm vitest run tests/status.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/miniapp/pages/status/status.vue frontend/miniapp/tests/status.spec.ts
git commit -m "feat: add miniapp status page"
```

---

## Part E: CI (Task 8)

### Task 8: K8s/Monitoring Lint in CI

**Files:**
- Modify: `.github/workflows/backend.yml`

**Step 1: Write the failing test**

Create `scripts/verify_k8s_ci_test.go`:

```go
package scripts

import (
    "os"
    "testing"
)

func TestK8sWorkflowExists(t *testing.T) {
    if _, err := os.Stat(".github/workflows/backend.yml"); err != nil {
        t.Fatal("expected backend workflow")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `go test ./scripts -run TestK8sWorkflowExists -v`
Expected: FAIL

**Step 3: Write minimal implementation**

Add CI step to run `kubectl kustomize deploy/k8s` or `kubeval deploy/k8s/*.yaml`.

**Step 4: Run test to verify it passes**

Run: `go test ./scripts -run TestK8sWorkflowExists -v`
Expected: PASS

**Step 5: Commit**

```bash
git add .github/workflows/backend.yml scripts/verify_k8s_ci_test.go
git commit -m "chore: add k8s lint step in CI"
```

---

## Final Verification

Run:

```bash
cd backend && go test ./... -coverprofile=coverage.out -covermode=atomic -v
cd deploy/k8s && kubectl kustomize .
cd frontend/admin && pnpm vitest run --coverage && pnpm playwright test
cd frontend/web && pnpm vitest run --coverage && pnpm playwright test
cd frontend/miniapp && pnpm vitest run --coverage
```

Expected: All tests pass and coverage is 100%.
