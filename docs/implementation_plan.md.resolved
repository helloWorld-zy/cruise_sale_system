# Sprint 2 å…¨æ–‡ä»¶å®¡è®¡æŠ¥å‘Š & æ•´æ”¹æ–¹æ¡ˆ

> **å®¡è®¡ç»“è®ºï¼šğŸ”´ ä¸é€šè¿‡ (REJECTED)**
> å‘ç° **13 é¡¹è¿è§„**ï¼ŒåŒ…å« 3 é¡¹ CRITICALã€4 é¡¹ HIGHã€6 é¡¹ MEDIUMã€‚å¿…é¡»å…¨éƒ¨ä¿®å¤åé‡æ–° Reviewã€‚

---

## å®¡è®¡æ¸…å•é€é¡¹ç»“æœ

| # | æ£€æŸ¥é¡¹ | ç»“æœ | ä¸¥é‡çº§åˆ« |
|---|--------|------|----------|
| 1 | åº“å­˜ä¸€è‡´æ€§ï¼š[CabinInventory](file:///d:/cruise_sale_system/backend/internal/domain/cabin.go#28-36) å¹¶å‘æ›´æ–° | ğŸ”´ FAIL | CRITICAL |
| 2 | Pricing Matrix [sameDay](file:///d:/cruise_sale_system/backend/internal/service/pricing_service.go#17-22) æ—¶åŒºé£é™© | ğŸ”´ FAIL | HIGH |
| 3 | Meilisearch é›†æˆå¤±è´¥è¡¥å¿ | ğŸ”´ FAIL | CRITICAL |
| 4 | SQL Migration `idx_cabin_prices_sku_date` ç´¢å¼• | âœ… PASS | â€” |
| 5 | Sprint 2 å…¨éƒ¨åŠŸèƒ½å®Œæˆåº¦ | ğŸ”´ FAIL | CRITICAL |

---

## å‘ç°çš„å…¨éƒ¨è¿è§„é¡¹

### ğŸ”´ CRITICAL-01ï¼šåº“å­˜å¹¶å‘æ›´æ–°æ— ä»»ä½•ä¿æŠ¤

> [!CAUTION]
> `InventoryService.Adjust()` ä½¿ç”¨ Read-Modify-Write æ¨¡å¼ï¼Œä¸¤ä¸ªå¹¶å‘è¯·æ±‚å¯èƒ½åŒæ—¶è¯»å– `Total=10`ï¼Œå„è‡ªå‡ 2ï¼Œæœ€ç»ˆç»“æœä¸º 8ï¼ˆåº”ä¸º 6ï¼‰ã€‚åœ¨ç”µå•†åº“å­˜åœºæ™¯ä¸‹è¿™æ˜¯è‡´å‘½ç¼ºé™·ã€‚

**æ–‡ä»¶**: [inventory_service.go](file:///d:/cruise_sale_system/backend/internal/service/inventory_service.go#L14-L23)

```go
// å½“å‰å®ç° â€” å®Œå…¨æ— å¹¶å‘ä¿æŠ¤
func (s *InventoryService) Adjust(skuID int64, delta int) error {
    inv, err := s.repo.GetBySKU(skuID)  // READ
    // ...
    inv.Total += delta                    // MODIFY
    return s.repo.Update(&inv)            // WRITE â€” è¦†ç›–å¼å†™å…¥
}
```

**æ•´æ”¹æ–¹æ¡ˆ**: 
1. åœ¨ [InventoryRepo](file:///d:/cruise_sale_system/backend/internal/service/inventory_service.go#5-9) æ¥å£ä¸­æ–°å¢ `AdjustAtomic(skuID int64, delta int) error`
2. ç”¨ SQL åŸå­æ“ä½œ `UPDATE cabin_inventories SET total = total + ? WHERE cabin_sku_id = ? AND total + ? >= 0`
3. æˆ–ä½¿ç”¨ GORM çš„ä¹è§‚é” (`gorm:"column:version"`) + `WHERE version = ?`
4. è¡¥å……å¹¶å‘æµ‹è¯•ï¼ˆgoroutine æ¨¡æ‹Ÿç«äº‰ï¼‰

---

### ğŸ”´ CRITICAL-02ï¼šMeilisearch ç´¢å¼•æ¨é€æ— å¤±è´¥è¡¥å¿

> [!CAUTION]
> `MeiliIndexer.IndexCabin()` æ˜¯åŒæ­¥è°ƒç”¨ï¼Œä¸” `_ = task` ç›´æ¥ä¸¢å¼ƒäº†ä»»åŠ¡ IDã€‚å¦‚æœ Meilisearch å®•æœºæˆ–ç½‘ç»œæ•…éšœï¼ŒDB äº‹åŠ¡å·²æäº¤ä½†æœç´¢ç´¢å¼•ä¸¢å¤±ï¼Œé€ æˆæ•°æ®ä¸ä¸€è‡´ã€‚æ— é‡è¯•ã€æ— è¡¥å¿ã€æ— å‘Šè­¦ã€‚

**æ–‡ä»¶**: [meili.go](file:///d:/cruise_sale_system/backend/internal/pkg/search/meili.go#L11-L15)

```go
func (m *MeiliIndexer) IndexCabin(doc interface{}) error {
    task, err := m.client.Index("cabins").AddDocuments([]interface{}{doc}, nil)
    _ = task // ignore task for simple adapter  â† ä¸¢å¼ƒäº†ä»»åŠ¡ID
    return err
}
```

**æ•´æ”¹æ–¹æ¡ˆ**:
1. å°† Meilisearch æ¨é€æ”¹ä¸º **å¼‚æ­¥+é‡è¯•** æ¨¡å¼ï¼ˆä½¿ç”¨ channel æˆ– goroutine poolï¼‰
2. æ¨é€å¤±è´¥æ—¶è®°å½•åˆ° `index_sync_failures` è¡¨
3. æ·»åŠ å®šæ—¶è¡¥å¿ä»»åŠ¡ï¼ˆcron jobï¼‰æ‰«æå¤±è´¥è®°å½•é‡æ–°æ¨é€
4. åœ¨ [SearchService](file:///d:/cruise_sale_system/backend/internal/service/search_service.go#7-8) ä¸­åŒ…è£…é”™è¯¯æ—¥å¿—ï¼Œä¸èƒ½ç”¨ `_ = task` åæ‰

---

### ğŸ”´ CRITICAL-03ï¼šSprint 2 åŠŸèƒ½å®Œæˆåº¦ä¸¥é‡ä¸è¶³

> [!CAUTION]
> å¯¹ç…§ Sprint 2 è®¡åˆ’ï¼Œä»¥ä¸‹åŠŸèƒ½ç¼ºå¤±æˆ–ä»…ä¸ºç©ºå£³å ä½ç¬¦ï¼š

| è®¡åˆ’è¦æ±‚ | å®é™…çŠ¶æ€ | é—®é¢˜ |
|----------|----------|------|
| Route/Voyage/Cabin Admin **CRUD** (Create/Update/Delete) | ä»… List (GET)ï¼Œæ—  POST/PUT/DELETE | åªåšäº† 1/4 |
| [VoyageHandler](file:///d:/cruise_sale_system/backend/internal/handler/voyage_handler.go#5-6) ä¾èµ–æ³¨å…¥ | ç©º structï¼Œ[List()](file:///d:/cruise_sale_system/backend/internal/repository/route_repo.go#15-19) è¿”å›ç¡¬ç¼–ç ç©ºæ•°ç»„ | æœªè¿æ¥ Service |
| [CabinHandler](file:///d:/cruise_sale_system/backend/internal/handler/cabin_handler.go#5-6) ä¾èµ–æ³¨å…¥ | ç©º structï¼Œ[List()](file:///d:/cruise_sale_system/backend/internal/repository/route_repo.go#15-19) è¿”å›ç¡¬ç¼–ç ç©ºæ•°ç»„ | æœªè¿æ¥ Service |
| Admin Cabin SKU é¡µé¢ | [cabins/index.vue](file:///d:/cruise_sale_system/frontend/admin/app/pages/cabins/index.vue) ä»… `<h1>Cabins</h1>` | ç©ºå£³ |
| Admin Inventory é¡µé¢ | [cabins/inventory.vue](file:///d:/cruise_sale_system/frontend/admin/app/pages/cabins/inventory.vue) ä»… `<h1>Inventory</h1>` | ç©ºå£³ |
| Web Cabin Detail ä»·æ ¼æ—¥å† | `[id].vue` ä»…å ä½æ–‡å­— | ç©ºå£³ |
| Miniapp Cabin Detail | [detail.vue](file:///d:/cruise_sale_system/frontend/miniapp/pages/cabin/detail.vue) ä»… `<text>Cabin Detail</text>` | ç©ºå£³ |
| å‰ç«¯æ‰€æœ‰é¡µé¢è°ƒç”¨ API | æ‰€æœ‰æ•°æ®éƒ½æ˜¯ **ç¡¬ç¼–ç  mock** | æœªæ¥å…¥åç«¯ |
| [InventoryLog](file:///d:/cruise_sale_system/backend/internal/domain/cabin.go#37-44) è®°å½• | åŸŸæ¨¡å‹å®šä¹‰äº†ä½† Service ä»æœªå†™å…¥æ—¥å¿— | åŠŸèƒ½ç¼ºå¤± |
| Admin é¡µé¢ä½¿ç”¨ Pinia store | æ— ä»»ä½• Pinia store | æ¶æ„ä¸ç¬¦ |

---

### ğŸŸ  HIGH-01ï¼š[sameDay()](file:///d:/cruise_sale_system/backend/internal/service/pricing_service.go#17-22) æ—¶åŒºå¯¹æ¯”ä¸å®‰å…¨

**æ–‡ä»¶**: [pricing_service.go](file:///d:/cruise_sale_system/backend/internal/service/pricing_service.go#L17-L21)

```go
func sameDay(a, b time.Time) bool {
    y1, m1, d1 := a.Date()  // ä½¿ç”¨å„è‡ª time.Time çš„ Location
    y2, m2, d2 := b.Date()
    return y1 == y2 && m1 == m2 && d1 == d2
}
```

`a.Date()` ä½¿ç”¨ `a` è‡ªèº«çš„æ—¶åŒºï¼Œ`b.Date()` ä½¿ç”¨ `b` è‡ªèº«çš„æ—¶åŒºã€‚å¦‚æœæ•°æ®åº“è¿”å› UTC è€Œå‰ç«¯ä¼ å…¥ `Asia/Shanghai (+8)`ï¼Œåˆ™ `2026-05-01 01:00 CST` vs `2026-04-30 17:00 UTC` ä¼šè¢«åˆ¤å®šä¸ºä¸åŒæ—¥æœŸã€‚

**æ•´æ”¹æ–¹æ¡ˆ**: ç»Ÿä¸€ä½¿ç”¨ UTC å¯¹æ¯”ï¼š
```go
func sameDay(a, b time.Time) bool {
    a, b = a.UTC(), b.UTC()
    y1, m1, d1 := a.Date()
    y2, m2, d2 := b.Date()
    return y1 == y2 && m1 == m2 && d1 == d2
}
```

---

### ğŸŸ  HIGH-02ï¼š`PricingService.FindPrice` åæ‰é”™è¯¯

**æ–‡ä»¶**: [pricing_service.go](file:///d:/cruise_sale_system/backend/internal/service/pricing_service.go#L23-L24)

```go
func (s *PricingService) FindPrice(...) (int64, bool) {
    list, _ := s.repo.ListBySKU(skuID)  // â† é”™è¯¯è¢«é™é»˜åæ‰
```

æ•°æ®åº“æŸ¥è¯¢å¤±è´¥æ—¶è¿”å› [(0, false)](file:///d:/cruise_sale_system/backend/internal/repository/route_repo.go#15-19)ï¼Œè°ƒç”¨æ–¹æ— æ³•åŒºåˆ†"æ— ä»·æ ¼"å’Œ"æ•°æ®åº“æ•…éšœ"ã€‚

**æ•´æ”¹æ–¹æ¡ˆ**: è¿”å› [(int64, bool, error)](file:///d:/cruise_sale_system/backend/internal/repository/route_repo.go#15-19) ä¸‰å…ƒç»„ï¼Œå°†é”™è¯¯å‘ä¸Šä¼ æ’­ã€‚

---

### ğŸŸ  HIGH-03ï¼š`RouteHandler.List` å’Œ `InventoryService.Adjust` åæ‰é”™è¯¯

**æ–‡ä»¶**: [route_handler.go](file:///d:/cruise_sale_system/backend/internal/handler/route_handler.go#L17)

```go
list, _ = h.svc.List()  // â† é”™è¯¯æœªå¤„ç†
```

[inventory_service.go](file:///d:/cruise_sale_system/backend/internal/service/inventory_service.go#L19-L20):
```go
if inv.Total+delta < 0 { return nil }  // â† åº“å­˜ä¸è¶³åº”è¿”å›ä¸šåŠ¡é”™è¯¯ï¼Œè€Œé nil
```

**æ•´æ”¹æ–¹æ¡ˆ**: æ‰€æœ‰ `_` å¿…é¡»æ”¹ä¸ºé”™è¯¯å¤„ç†ã€‚åº“å­˜ä¸è¶³åº”è¿”å› `ErrInsufficientInventory`ã€‚

---

### ğŸŸ  HIGH-04ï¼šRoute/Voyage/Cabin Repository ä¸ç¬¦åˆå·²æœ‰ DDD è§„èŒƒ

**æ–‡ä»¶**: [repository.go](file:///d:/cruise_sale_system/backend/internal/domain/repository.go) vs [route_repo.go](file:///d:/cruise_sale_system/backend/internal/repository/route_repo.go)

å·²æœ‰çš„ [CompanyRepository](file:///d:/cruise_sale_system/backend/internal/domain/repository.go#5-12)ã€[CruiseRepository](file:///d:/cruise_sale_system/backend/internal/domain/repository.go#13-20) æ¥å£ç»Ÿä¸€ä½¿ç”¨ `context.Context` å‚æ•°å’Œå®Œæ•´ CRUD ç­¾åã€‚Sprint 2 çš„ Repositoryï¼š
- æ—  `context.Context` å‚æ•°
- æ—  [GetByID](file:///d:/cruise_sale_system/backend/internal/domain/repository.go#24-25) / [Update](file:///d:/cruise_sale_system/backend/internal/domain/repository.go#7-8) / [Delete](file:///d:/cruise_sale_system/backend/internal/domain/repository.go#26-27) æ–¹æ³•
- æ¥å£æœªåœ¨ [domain/repository.go](file:///d:/cruise_sale_system/backend/internal/domain/repository.go) ä¸­å£°æ˜ï¼ˆè¿å DDD ç«¯å£å®šä¹‰ï¼‰

**æ•´æ”¹æ–¹æ¡ˆ**: æŒ‰å·²æœ‰æ¨¡å¼è¡¥å…¨å®Œæ•´ CRUD æ¥å£åŠ `ctx context.Context` å‚æ•°ã€‚

---

### ğŸŸ¡ MEDIUM-01ï¼šæµ‹è¯•è¦†ç›–ç‡è¿œæœªè¾¾åˆ° 100%

| å±‚çº§ | è¦æ±‚ 100% è¦†ç›– | å®é™… |
|------|---------------|------|
| `domain/` | Voyage, CabinSKU, CabinPrice, CabinInventory, InventoryLog æ¨¡å‹æµ‹è¯• | âŒ ä»… Route ä¸€ä¸ªæµ‹è¯• |
| `repository/` | VoyageRepo, CabinRepo æµ‹è¯• | âŒ ä»… RouteRepo æµ‹è¯• |
| `service/` | SearchService é”™è¯¯è·¯å¾„ã€InventoryService è¾¹ç•Œ | âŒ ä»… happy path |
| `handler/` | VoyageHandler, CabinHandler æµ‹è¯• | âŒ ä»… RouteHandler |
| Admin å‰ç«¯ | voyages, cabins/index, cabins/inventory é¡µé¢æµ‹è¯• | âŒ ä»… routes + pricing |
| Web å‰ç«¯ | `cabins/[id].vue` æµ‹è¯• | âŒ æ—  |
| Miniapp | CabinCard, detail æµ‹è¯• | âŒ ä»… list |

---

### ğŸŸ¡ MEDIUM-02ï¼šè¿ç§»ç¼–å·å†²çª

**æ–‡ä»¶**: `backend/migrations/` ç›®å½•ä¸­å­˜åœ¨ä¸¤ä¸ª `000002_*` å‰ç¼€æ–‡ä»¶ï¼š
- `000002_add_staff_roles.up.sql`
- `000002_route_voyage_cabin.up.sql`

è¿™ä¼šå¯¼è‡´ `golang-migrate` è¿è¡Œæ—¶å†²çªæŠ¥é”™ã€‚

**æ•´æ”¹æ–¹æ¡ˆ**: Sprint 2 è¿ç§»åº”æ”¹ä¸º `000003_route_voyage_cabin`.

---

### ğŸŸ¡ MEDIUM-03ï¼šå‰ç«¯ç¡¬ç¼–ç æ•°æ®ï¼Œæœªä½¿ç”¨ `useApi` composable

æ‰€æœ‰ Sprint 2 å‰ç«¯é¡µé¢æ•°æ®éƒ½æ˜¯å†…è”ç¡¬ç¼–ç  (`const items = [...]`)ï¼Œè€Œé¡¹ç›®å·²æœ‰ `useApi` composableï¼ˆæœ‰å¯¹åº”æµ‹è¯•ï¼‰ã€‚åº”ä½¿ç”¨ `useFetch` / `useApi` è°ƒç”¨åç«¯ APIã€‚

---

### ğŸŸ¡ MEDIUM-04ï¼š`VoyageHandler` / `CabinHandler` æ— ä¾èµ–æ³¨å…¥

```go
type VoyageHandler struct{}          // ç©ºï¼Œæ—  Service æ³¨å…¥
func NewVoyageHandler() *VoyageHandler  // æ— å‚æ•°
```

è¿å DDD + ä¾èµ–æ³¨å…¥è¦æ±‚ã€‚

---

### ğŸŸ¡ MEDIUM-05ï¼š`RouteHandler.RouteService` æ¥å£ä½¿ç”¨ `[]interface{}`

```go
type RouteService interface{ List() ([]interface{}, error) }
```

åº”è¿”å› `[]domain.Route` è€Œéç©ºæ¥å£åˆ‡ç‰‡ã€‚ç±»å‹å®‰å…¨ç¼ºå¤±ã€‚

---

### ğŸŸ¡ MEDIUM-06ï¼šCI ä¸­ Go ç‰ˆæœ¬ä¸ `go.mod` ä¸åŒ¹é…

CI ä½¿ç”¨ `go-version: "1.23.x"`ï¼Œä½†é¡¹ç›®å£°æ˜ä½¿ç”¨ **Go 1.26**ã€‚

---

## æ•´æ”¹ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ç¼–å· | é¢„ä¼°å·¥æ—¶ |
|--------|------|----------|
| P0-ç«‹å³ | CRITICAL-01 (å¹¶å‘) | 2h |
| P0-ç«‹å³ | CRITICAL-02 (Meilisearch) | 2h |
| P0-ç«‹å³ | CRITICAL-03 (åŠŸèƒ½ç¼ºå¤±) | 8h |
| P1-é«˜ | HIGH-01 (æ—¶åŒº) | 0.5h |
| P1-é«˜ | HIGH-02 (åé”™è¯¯) | 0.5h |
| P1-é«˜ | HIGH-03 (åé”™è¯¯) | 0.5h |
| P1-é«˜ | HIGH-04 (DDDä¸ç¬¦) | 2h |
| P2-ä¸­ | MEDIUM-01~06 | 4h |

---

## Verification Plan

### Automated Tests

ä¿®å¤å®Œæˆåéœ€è¿è¡Œä»¥ä¸‹å…¨éƒ¨é€šè¿‡ï¼š

```bash
# Backend - å…¨é‡æµ‹è¯• + è¦†ç›–ç‡
cd d:\cruise_sale_system\backend && go test ./... -coverprofile=coverage.out -covermode=atomic -v

# Admin å‰ç«¯
cd d:\cruise_sale_system\frontend\admin && pnpm vitest run --coverage

# Web å‰ç«¯
cd d:\cruise_sale_system\frontend\web && pnpm vitest run --coverage

# Miniapp å‰ç«¯
cd d:\cruise_sale_system\frontend\miniapp && pnpm test
```

### Manual Verification
- ç¡®è®¤ `go tool cover -func=coverage.out` æ˜¾ç¤ºæ‰€æœ‰ Sprint 2 æ–‡ä»¶è¾¾åˆ° 100% è¦†ç›–ç‡
- ç¡®è®¤ `000003_route_voyage_cabin.up.sql` èƒ½åœ¨ PostgreSQL ä¸Šæ­£å¸¸ migrate up/down
