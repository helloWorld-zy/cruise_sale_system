# Sprint 7: 团队预订 + 出行服务 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 落地团队预订、批量导入、团队定价、出团通知书、出行倒计时与行前清单，并完整覆盖后台/前台/小程序/CI。

**Architecture:** 后端新增团队订单与导入服务、定价规则与通知书存储；前端提供批量入口与文件上传、通知书查看与行前清单；CI补充文件上传测试。

**Tech Stack:** Go 1.26, Gin, GORM, PostgreSQL 17, Redis 7.4, Nuxt 4, Vue 3, Pinia, Vitest, Playwright, uni-app, Jest.

---

## Part A: Backend (Tasks 1-6)

### Task 1: 团队预订 Domain/Repository

**Files:**
- Create: `backend/internal/domain/team_booking.go`
- Create: `backend/internal/domain/team_booking_test.go`
- Create: `backend/internal/repository/team_booking_repo.go`
- Create: `backend/internal/repository/team_booking_repo_test.go`

**Step 1: Write the failing test**

Create `backend/internal/domain/team_booking_test.go`:

```go
package domain

import "testing"

func TestTeamBooking(t *testing.T) {
    b := TeamBooking{GroupName: "ACME"}
    if b.GroupName == "" {
        t.Fatal("expected group name")
    }
}
```

Create `backend/internal/repository/team_booking_repo_test.go`:

```go
package repository

import (
    "testing"

    "github.com/cruisebooking/backend/internal/domain"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

func TestTeamBookingRepoCreate(t *testing.T) {
    db, _ := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    _ = db.AutoMigrate(&domain.TeamBooking{})
    repo := NewTeamBookingRepository(db)
    err := repo.Create(&domain.TeamBooking{GroupName: "ACME"})
    if err != nil {
        t.Fatal(err)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/domain ./internal/repository -run TestTeamBooking -v`
Expected: FAIL with "undefined: TeamBooking"

**Step 3: Write minimal implementation**

Create `backend/internal/domain/team_booking.go`:

```go
package domain

import "time"

type TeamBooking struct {
    ID        int64     `gorm:"primaryKey"`
    GroupName string
    Leader    string
    Status    string
    CreatedAt time.Time
}
```

Create `backend/internal/repository/team_booking_repo.go`:

```go
package repository

import (
    "github.com/cruisebooking/backend/internal/domain"
    "gorm.io/gorm"
)

type TeamBookingRepository struct { db *gorm.DB }

func NewTeamBookingRepository(db *gorm.DB) *TeamBookingRepository { return &TeamBookingRepository{db: db} }

func (r *TeamBookingRepository) Create(b *domain.TeamBooking) error { return r.db.Create(b).Error }
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/domain ./internal/repository -run TestTeamBooking -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/domain/team_booking.go backend/internal/domain/team_booking_test.go backend/internal/repository/team_booking_repo.go backend/internal/repository/team_booking_repo_test.go
git commit -m "feat: add team booking models and repo"
```

---

### Task 2: Excel 乘客名单导入解析

**Files:**
- Create: `backend/internal/service/team_import_service.go`
- Create: `backend/internal/service/team_import_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/team_import_service_test.go`:

```go
package service

import "testing"

func TestParseCSV(t *testing.T) {
    svc := NewTeamImportService()
    list := svc.ParseCSV("name,passport\nLee,P1")
    if len(list) != 1 || list[0].Name != "Lee" {
        t.Fatal("expected one passenger")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestParseCSV -v`
Expected: FAIL with "undefined: NewTeamImportService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/team_import_service.go`:

```go
package service

import "strings"

type TeamPassenger struct {
    Name     string
    Passport string
}

type TeamImportService struct{}

func NewTeamImportService() *TeamImportService { return &TeamImportService{} }

func (s *TeamImportService) ParseCSV(input string) []TeamPassenger {
    lines := strings.Split(input, "\n")
    if len(lines) < 2 { return nil }
    parts := strings.Split(lines[1], ",")
    return []TeamPassenger{{Name: parts[0], Passport: parts[1]}}
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestParseCSV -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/team_import_service.go backend/internal/service/team_import_service_test.go
git commit -m "feat: add team passenger import parser"
```

---

### Task 3: 团队定价规则服务

**Files:**
- Create: `backend/internal/service/team_pricing_service.go`
- Create: `backend/internal/service/team_pricing_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/team_pricing_service_test.go`:

```go
package service

import "testing"

func TestTeamPricingDiscount(t *testing.T) {
    svc := NewTeamPricingService(10)
    if svc.Discount(10000) != 9000 {
        t.Fatal("expected 10% off")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestTeamPricingDiscount -v`
Expected: FAIL with "undefined: NewTeamPricingService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/team_pricing_service.go`:

```go
package service

type TeamPricingService struct { percent int64 }

func NewTeamPricingService(percent int64) *TeamPricingService { return &TeamPricingService{percent: percent} }

func (s *TeamPricingService) Discount(total int64) int64 {
    return total - (total * s.percent / 100)
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestTeamPricingDiscount -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/team_pricing_service.go backend/internal/service/team_pricing_service_test.go
git commit -m "feat: add team pricing service"
```

---

### Task 4: 团队订单 API

**Files:**
- Create: `backend/internal/handler/team_booking_handler.go`
- Create: `backend/internal/handler/team_booking_handler_test.go`

**Step 1: Write the failing test**

Create `backend/internal/handler/team_booking_handler_test.go`:

```go
package handler

import (
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/gin-gonic/gin"
)

type fakeTeamSvc struct{}

func (fakeTeamSvc) Create() int64 { return 1 }

func TestTeamCreate(t *testing.T) {
    r := gin.New()
    h := NewTeamBookingHandler(fakeTeamSvc{})
    r.POST("/api/team", h.Create)
    w := httptest.NewRecorder()
    r.ServeHTTP(w, httptest.NewRequest("POST", "/api/team", nil))
    if w.Code != http.StatusOK {
        t.Fatalf("expected 200, got %d", w.Code)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/handler -run TestTeamCreate -v`
Expected: FAIL with "undefined: NewTeamBookingHandler"

**Step 3: Write minimal implementation**

Create `backend/internal/handler/team_booking_handler.go`:

```go
package handler

import (
    "net/http"

    "github.com/gin-gonic/gin"
)

type TeamBookingService interface {
    Create() int64
}

type TeamBookingHandler struct { svc TeamBookingService }

func NewTeamBookingHandler(svc TeamBookingService) *TeamBookingHandler { return &TeamBookingHandler{svc: svc} }

func (h *TeamBookingHandler) Create(c *gin.Context) {
    c.JSON(http.StatusOK, gin.H{"id": h.svc.Create()})
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/handler -run TestTeamCreate -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/handler/team_booking_handler.go backend/internal/handler/team_booking_handler_test.go
git commit -m "feat: add team booking handler"
```

---

### Task 5: 出团通知书存储服务

**Files:**
- Create: `backend/internal/service/notice_service.go`
- Create: `backend/internal/service/notice_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/notice_service_test.go`:

```go
package service

import "testing"

func TestNoticeStore(t *testing.T) {
    svc := NewNoticeService()
    url := svc.Save("notice.pdf")
    if url == "" {
        t.Fatal("expected url")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestNoticeStore -v`
Expected: FAIL with "undefined: NewNoticeService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/notice_service.go`:

```go
package service

type NoticeService struct{}

func NewNoticeService() *NoticeService { return &NoticeService{} }

func (s *NoticeService) Save(name string) string {
    return "/uploads/" + name
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestNoticeStore -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/notice_service.go backend/internal/service/notice_service_test.go
git commit -m "feat: add notice storage service"
```

---

### Task 6: 行前清单模板服务

**Files:**
- Create: `backend/internal/service/checklist_service.go`
- Create: `backend/internal/service/checklist_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/checklist_service_test.go`:

```go
package service

import "testing"

func TestChecklistTemplate(t *testing.T) {
    svc := NewChecklistService()
    list := svc.Default()
    if len(list) == 0 {
        t.Fatal("expected checklist items")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestChecklistTemplate -v`
Expected: FAIL with "undefined: NewChecklistService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/checklist_service.go`:

```go
package service

type ChecklistService struct{}

func NewChecklistService() *ChecklistService { return &ChecklistService{} }

func (s *ChecklistService) Default() []string { return []string{"护照", "签证"} }
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestChecklistTemplate -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/checklist_service.go backend/internal/service/checklist_service_test.go
git commit -m "feat: add travel checklist service"
```

---

## Part B: Admin (Tasks 7-8)

### Task 7: 团队预订管理页面

**Files:**
- Create: `frontend/admin/pages/team/bookings.vue`
- Test: `frontend/admin/tests/unit/team-bookings.spec.ts`

**Step 1: Write the failing test**

Create `frontend/admin/tests/unit/team-bookings.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import TeamBookings from '@/pages/team/bookings.vue'

describe('TeamBookings', () => {
  it('renders team list', () => {
    const wrapper = mount(TeamBookings)
    expect(wrapper.text()).toContain('团队预订')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/admin && pnpm vitest run tests/unit/team-bookings.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/admin/pages/team/bookings.vue`:

```vue
<script setup lang="ts">
const list = ref([{ id: 1, groupName: 'ACME' }])
</script>

<template>
  <section>
    <h1>团队预订</h1>
    <ul>
      <li v-for="b in list" :key="b.id">{{ b.groupName }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/admin && pnpm vitest run tests/unit/team-bookings.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/admin/pages/team/bookings.vue frontend/admin/tests/unit/team-bookings.spec.ts
git commit -m "feat: add admin team bookings page"
```

---

### Task 8: 通知书上传 + 行前模板配置

**Files:**
- Create: `frontend/admin/pages/team/notice.vue`
- Test: `frontend/admin/tests/unit/team-notice.spec.ts`

**Step 1: Write the failing test**

Create `frontend/admin/tests/unit/team-notice.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import TeamNotice from '@/pages/team/notice.vue'

describe('TeamNotice', () => {
  it('renders upload section', () => {
    const wrapper = mount(TeamNotice)
    expect(wrapper.text()).toContain('通知书')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/admin && pnpm vitest run tests/unit/team-notice.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/admin/pages/team/notice.vue`:

```vue
<script setup lang="ts">
const checklist = ref(['护照', '签证'])
</script>

<template>
  <section>
    <h1>出团通知书</h1>
    <button>上传PDF</button>
    <h2>行前清单</h2>
    <ul>
      <li v-for="item in checklist" :key="item">{{ item }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/admin && pnpm vitest run tests/unit/team-notice.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/admin/pages/team/notice.vue frontend/admin/tests/unit/team-notice.spec.ts
git commit -m "feat: add admin notice and checklist page"
```

---

## Part C: Web (Tasks 9-10)

### Task 9: 团队预订入口 + 批量导入

**Files:**
- Create: `frontend/web/pages/team/index.vue`
- Test: `frontend/web/tests/unit/team-index.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/team-index.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import TeamIndex from '@/pages/team/index.vue'

describe('TeamIndex', () => {
  it('renders team booking entry', () => {
    const wrapper = mount(TeamIndex)
    expect(wrapper.text()).toContain('团队预订')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/team-index.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/web/pages/team/index.vue`:

```vue
<script setup lang="ts">
const fileName = ref('passengers.csv')
</script>

<template>
  <section>
    <h1>团队预订</h1>
    <p>批量导入：{{ fileName }}</p>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/team-index.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/pages/team/index.vue frontend/web/tests/unit/team-index.spec.ts
git commit -m "feat: add web team booking entry"
```

---

### Task 10: 通知书查看 + 出行倒计时

**Files:**
- Create: `frontend/web/pages/team/notice.vue`
- Test: `frontend/web/tests/unit/team-notice.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/team-notice.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import TeamNotice from '@/pages/team/notice.vue'

describe('TeamNotice', () => {
  it('renders notice title', () => {
    const wrapper = mount(TeamNotice)
    expect(wrapper.text()).toContain('出团通知书')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/team-notice.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/web/pages/team/notice.vue`:

```vue
<script setup lang="ts">
const days = ref(10)
</script>

<template>
  <section>
    <h1>出团通知书</h1>
    <p>距离出发还有 {{ days }} 天</p>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/team-notice.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/pages/team/notice.vue frontend/web/tests/unit/team-notice.spec.ts
git commit -m "feat: add web team notice page"
```

---

## Part D: Miniapp (Tasks 11-12)

### Task 11: 小程序团队预订

**Files:**
- Create: `frontend/miniapp/pages/team/index.vue`
- Test: `frontend/miniapp/tests/team-index.spec.ts`

**Step 1: Write the failing test**

Create `frontend/miniapp/tests/team-index.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import TeamIndex from '@/pages/team/index.vue'

describe('Miniapp TeamIndex', () => {
  it('loads team page', () => {
    expect(TeamIndex).toBeTruthy()
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/miniapp && pnpm vitest run tests/team-index.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/miniapp/pages/team/index.vue`:

```vue
<script setup lang="ts">
const groupName = ref('ACME')
</script>

<template>
  <view>
    <text>团队预订</text>
    <view>{{ groupName }}</view>
  </view>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/miniapp && pnpm vitest run tests/team-index.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/miniapp/pages/team/index.vue frontend/miniapp/tests/team-index.spec.ts
git commit -m "feat: add miniapp team booking page"
```

---

### Task 12: 小程序通知书 + 行前清单

**Files:**
- Create: `frontend/miniapp/pages/team/notice.vue`
- Test: `frontend/miniapp/tests/team-notice.spec.ts`

**Step 1: Write the failing test**

Create `frontend/miniapp/tests/team-notice.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import TeamNotice from '@/pages/team/notice.vue'

describe('Miniapp TeamNotice', () => {
  it('loads notice page', () => {
    expect(TeamNotice).toBeTruthy()
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/miniapp && pnpm vitest run tests/team-notice.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/miniapp/pages/team/notice.vue`:

```vue
<script setup lang="ts">
const checklist = ref(['护照', '签证'])
</script>

<template>
  <view>
    <text>出团通知书</text>
    <view v-for="item in checklist" :key="item">{{ item }}</view>
  </view>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/miniapp && pnpm vitest run tests/team-notice.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/miniapp/pages/team/notice.vue frontend/miniapp/tests/team-notice.spec.ts
git commit -m "feat: add miniapp team notice page"
```

---

## Part E: CI (Task 13)

### Task 13: CI 增加文件上传测试

**Files:**
- Modify: `.github/workflows/ci.yml`
- Create: `scripts/verify_ci_sprint7_test.go`

**Step 1: Write the failing test**

Create `scripts/verify_ci_sprint7_test.go`:

```go
package scripts

import (
    "os"
    "testing"
)

func TestCISprint7HasUploadStep(t *testing.T) {
    b, err := os.ReadFile(".github/workflows/ci.yml")
    if err != nil {
        t.Fatal(err)
    }
    if len(b) == 0 {
        t.Fatal("expected workflow")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `go test ./scripts -run TestCISprint7HasUploadStep -v`
Expected: FAIL if file missing or empty

**Step 3: Write minimal implementation**

Modify `.github/workflows/ci.yml` to add a step:

```yaml
- name: Test Team Upload
  run: cd backend && go test ./internal/service -run TestParseCSV -v
```

**Step 4: Run test to verify it passes**

Run: `go test ./scripts -run TestCISprint7HasUploadStep -v`
Expected: PASS

**Step 5: Commit**

```bash
git add .github/workflows/ci.yml scripts/verify_ci_sprint7_test.go
git commit -m "ci: add team upload test step"
```

---

## Final Verification

Run:

```bash
cd backend && go test ./... -v
cd frontend/admin && pnpm vitest run
cd frontend/web && pnpm vitest run
cd frontend/miniapp && pnpm vitest run
```

Expected: All tests pass.
