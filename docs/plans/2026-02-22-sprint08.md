# Sprint 8: 实时信息 + 在线客服 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 实时舱位与价格变动提醒、预订进度追踪、AI客服与人工转接、天气与港口信息展示，并覆盖后台/前台/小程序/CI。

**Architecture:** 后端新增WebSocket实时通道、价格提醒与进度事件、客服与FAQ服务、外部天气/港口API适配；前端提供实时视图与客服工作台；CI补充WebSocket与聊天测试。

**Tech Stack:** Go 1.26, Gin, GORM, PostgreSQL 17, Redis 7.4, Nuxt 4, Vue 3, Pinia, Vitest, Playwright, uni-app, Jest.

---

## Part A: Backend (Tasks 1-6)

### Task 1: WebSocket Hub

**Files:**
- Create: `backend/internal/service/ws_hub.go`
- Create: `backend/internal/service/ws_hub_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/ws_hub_test.go`:

```go
package service

import "testing"

func TestHubBroadcast(t *testing.T) {
    hub := NewHub()
    hub.Broadcast("cabin:1")
    if hub.LastMessage() != "cabin:1" {
        t.Fatal("expected broadcast message")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestHubBroadcast -v`
Expected: FAIL with "undefined: NewHub"

**Step 3: Write minimal implementation**

Create `backend/internal/service/ws_hub.go`:

```go
package service

type Hub struct { last string }

func NewHub() *Hub { return &Hub{} }

func (h *Hub) Broadcast(msg string) { h.last = msg }

func (h *Hub) LastMessage() string { return h.last }
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestHubBroadcast -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/ws_hub.go backend/internal/service/ws_hub_test.go
git commit -m "feat: add websocket hub"
```

---

### Task 2: 价格变动关注服务

**Files:**
- Create: `backend/internal/service/price_alert_service.go`
- Create: `backend/internal/service/price_alert_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/price_alert_service_test.go`:

```go
package service

import "testing"

func TestPriceAlertSubscribe(t *testing.T) {
    svc := NewPriceAlertService()
    svc.Subscribe(1, 1001)
    if len(svc.List(1)) != 1 {
        t.Fatal("expected subscription")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestPriceAlertSubscribe -v`
Expected: FAIL with "undefined: NewPriceAlertService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/price_alert_service.go`:

```go
package service

type PriceAlertService struct { subs map[int64][]int64 }

func NewPriceAlertService() *PriceAlertService { return &PriceAlertService{subs: map[int64][]int64{}} }

func (s *PriceAlertService) Subscribe(userID, cabinID int64) {
    s.subs[userID] = append(s.subs[userID], cabinID)
}

func (s *PriceAlertService) List(userID int64) []int64 { return s.subs[userID] }
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestPriceAlertSubscribe -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/price_alert_service.go backend/internal/service/price_alert_service_test.go
git commit -m "feat: add price alert service"
```

---

### Task 3: 预订进度事件服务

**Files:**
- Create: `backend/internal/service/booking_timeline_service.go`
- Create: `backend/internal/service/booking_timeline_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/booking_timeline_service_test.go`:

```go
package service

import "testing"

func TestTimelineAppend(t *testing.T) {
    svc := NewBookingTimelineService()
    svc.Append(1001, "支付成功")
    if len(svc.List(1001)) != 1 {
        t.Fatal("expected one event")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestTimelineAppend -v`
Expected: FAIL with "undefined: NewBookingTimelineService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/booking_timeline_service.go`:

```go
package service

type BookingTimelineService struct { events map[int64][]string }

func NewBookingTimelineService() *BookingTimelineService { return &BookingTimelineService{events: map[int64][]string{}} }

func (s *BookingTimelineService) Append(orderID int64, event string) { s.events[orderID] = append(s.events[orderID], event) }

func (s *BookingTimelineService) List(orderID int64) []string { return s.events[orderID] }
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestTimelineAppend -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/booking_timeline_service.go backend/internal/service/booking_timeline_service_test.go
git commit -m "feat: add booking timeline service"
```

---

### Task 4: FAQ AI 客服服务

**Files:**
- Create: `backend/internal/service/faq_bot_service.go`
- Create: `backend/internal/service/faq_bot_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/faq_bot_service_test.go`:

```go
package service

import "testing"

func TestFAQBotReply(t *testing.T) {
    svc := NewFAQBotService(map[string]string{"退改": "请联系客服"})
    if svc.Reply("退改") == "" {
        t.Fatal("expected reply")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestFAQBotReply -v`
Expected: FAIL with "undefined: NewFAQBotService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/faq_bot_service.go`:

```go
package service

type FAQBotService struct { kb map[string]string }

func NewFAQBotService(kb map[string]string) *FAQBotService { return &FAQBotService{kb: kb} }

func (s *FAQBotService) Reply(question string) string {
    if v, ok := s.kb[question]; ok { return v }
    return "请描述问题"
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestFAQBotReply -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/faq_bot_service.go backend/internal/service/faq_bot_service_test.go
git commit -m "feat: add faq bot service"
```

---

### Task 5: 客服工单服务

**Files:**
- Create: `backend/internal/domain/support_ticket.go`
- Create: `backend/internal/domain/support_ticket_test.go`

**Step 1: Write the failing test**

Create `backend/internal/domain/support_ticket_test.go`:

```go
package domain

import "testing"

func TestSupportTicket(t *testing.T) {
    tkt := SupportTicket{UserID: 1, Status: "open"}
    if tkt.Status != "open" {
        t.Fatal("expected open status")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/domain -run TestSupportTicket -v`
Expected: FAIL with "undefined: SupportTicket"

**Step 3: Write minimal implementation**

Create `backend/internal/domain/support_ticket.go`:

```go
package domain

import "time"

type SupportTicket struct {
    ID        int64     `gorm:"primaryKey"`
    UserID    int64
    Subject   string
    Status    string
    CreatedAt time.Time
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/domain -run TestSupportTicket -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/domain/support_ticket.go backend/internal/domain/support_ticket_test.go
git commit -m "feat: add support ticket model"
```

---

### Task 6: 天气与港口信息服务

**Files:**
- Create: `backend/internal/service/port_weather_service.go`
- Create: `backend/internal/service/port_weather_service_test.go`

**Step 1: Write the failing test**

Create `backend/internal/service/port_weather_service_test.go`:

```go
package service

import "testing"

func TestPortWeather(t *testing.T) {
    svc := NewPortWeatherService()
    info := svc.Get("Shanghai")
    if info.Port == "" {
        t.Fatal("expected port info")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `cd backend && go test ./internal/service -run TestPortWeather -v`
Expected: FAIL with "undefined: NewPortWeatherService"

**Step 3: Write minimal implementation**

Create `backend/internal/service/port_weather_service.go`:

```go
package service

type PortWeather struct {
    Port    string
    Weather string
}

type PortWeatherService struct{}

func NewPortWeatherService() *PortWeatherService { return &PortWeatherService{} }

func (s *PortWeatherService) Get(port string) PortWeather {
    return PortWeather{Port: port, Weather: "sunny"}
}
```

**Step 4: Run test to verify it passes**

Run: `cd backend && go test ./internal/service -run TestPortWeather -v`
Expected: PASS

**Step 5: Commit**

```bash
git add backend/internal/service/port_weather_service.go backend/internal/service/port_weather_service_test.go
git commit -m "feat: add port weather service"
```

---

## Part B: Admin (Tasks 7-8)

### Task 7: FAQ 管理页面

**Files:**
- Create: `frontend/admin/pages/support/faq.vue`
- Test: `frontend/admin/tests/unit/support-faq.spec.ts`

**Step 1: Write the failing test**

Create `frontend/admin/tests/unit/support-faq.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import SupportFAQ from '@/pages/support/faq.vue'

describe('SupportFAQ', () => {
  it('renders faq header', () => {
    const wrapper = mount(SupportFAQ)
    expect(wrapper.text()).toContain('FAQ')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/admin && pnpm vitest run tests/unit/support-faq.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/admin/pages/support/faq.vue`:

```vue
<script setup lang="ts">
const items = ref([{ q: '退改', a: '请联系客服' }])
</script>

<template>
  <section>
    <h1>FAQ</h1>
    <ul>
      <li v-for="item in items" :key="item.q">{{ item.q }} - {{ item.a }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/admin && pnpm vitest run tests/unit/support-faq.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/admin/pages/support/faq.vue frontend/admin/tests/unit/support-faq.spec.ts
git commit -m "feat: add admin faq page"
```

---

### Task 8: 客服工作台页面

**Files:**
- Create: `frontend/admin/pages/support/desk.vue`
- Test: `frontend/admin/tests/unit/support-desk.spec.ts`

**Step 1: Write the failing test**

Create `frontend/admin/tests/unit/support-desk.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import SupportDesk from '@/pages/support/desk.vue'

describe('SupportDesk', () => {
  it('renders desk header', () => {
    const wrapper = mount(SupportDesk)
    expect(wrapper.text()).toContain('客服工作台')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/admin && pnpm vitest run tests/unit/support-desk.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/admin/pages/support/desk.vue`:

```vue
<script setup lang="ts">
const tickets = ref([{ id: 1, subject: '支付问题' }])
</script>

<template>
  <section>
    <h1>客服工作台</h1>
    <ul>
      <li v-for="t in tickets" :key="t.id">{{ t.subject }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/admin && pnpm vitest run tests/unit/support-desk.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/admin/pages/support/desk.vue frontend/admin/tests/unit/support-desk.spec.ts
git commit -m "feat: add admin support desk"
```

---

## Part C: Web (Tasks 9-11)

### Task 9: 实时舱位状态 + 热度组件

**Files:**
- Create: `frontend/web/components/RealtimeCabinStatus.vue`
- Test: `frontend/web/tests/unit/realtime-cabin-status.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/realtime-cabin-status.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import RealtimeCabinStatus from '@/components/RealtimeCabinStatus.vue'

describe('RealtimeCabinStatus', () => {
  it('renders realtime header', () => {
    const wrapper = mount(RealtimeCabinStatus, { props: { count: 5 } })
    expect(wrapper.text()).toContain('实时')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/realtime-cabin-status.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/web/components/RealtimeCabinStatus.vue`:

```vue
<script setup lang="ts">
defineProps<{ count: number }>()
</script>

<template>
  <section>
    <h3>实时舱位</h3>
    <p>当前浏览热度：{{ count }}</p>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/realtime-cabin-status.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/components/RealtimeCabinStatus.vue frontend/web/tests/unit/realtime-cabin-status.spec.ts
git commit -m "feat: add realtime cabin status component"
```

---

### Task 10: 价格提醒 + 预订进度时间轴

**Files:**
- Create: `frontend/web/components/PriceAlert.vue`
- Create: `frontend/web/components/BookingTimeline.vue`
- Test: `frontend/web/tests/unit/price-alert.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/price-alert.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import PriceAlert from '@/components/PriceAlert.vue'

describe('PriceAlert', () => {
  it('renders alert button', () => {
    const wrapper = mount(PriceAlert)
    expect(wrapper.text()).toContain('价格提醒')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/price-alert.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/web/components/PriceAlert.vue`:

```vue
<script setup lang="ts">
const subscribed = ref(false)
</script>

<template>
  <section>
    <button @click="subscribed = true">价格提醒</button>
    <span v-if="subscribed">已关注</span>
  </section>
</template>
```

Create `frontend/web/components/BookingTimeline.vue`:

```vue
<script setup lang="ts">
defineProps<{ events: string[] }>()
</script>

<template>
  <section>
    <h3>预订进度</h3>
    <ul>
      <li v-for="e in events" :key="e">{{ e }}</li>
    </ul>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/price-alert.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/components/PriceAlert.vue frontend/web/components/BookingTimeline.vue frontend/web/tests/unit/price-alert.spec.ts
git commit -m "feat: add price alert and booking timeline"
```

---

### Task 11: 在线客服组件

**Files:**
- Create: `frontend/web/components/SupportChat.vue`
- Test: `frontend/web/tests/unit/support-chat.spec.ts`

**Step 1: Write the failing test**

Create `frontend/web/tests/unit/support-chat.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import SupportChat from '@/components/SupportChat.vue'

describe('SupportChat', () => {
  it('renders chat title', () => {
    const wrapper = mount(SupportChat)
    expect(wrapper.text()).toContain('在线客服')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/web && pnpm vitest run tests/unit/support-chat.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/web/components/SupportChat.vue`:

```vue
<script setup lang="ts">
const messages = ref<string[]>(['您好，请描述问题'])
</script>

<template>
  <section>
    <h3>在线客服</h3>
    <div v-for="m in messages" :key="m">{{ m }}</div>
  </section>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/web && pnpm vitest run tests/unit/support-chat.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/web/components/SupportChat.vue frontend/web/tests/unit/support-chat.spec.ts
git commit -m "feat: add web support chat"
```

---

## Part D: Miniapp (Tasks 12-13)

### Task 12: 小程序实时舱位 + 价格提醒

**Files:**
- Create: `frontend/miniapp/pages/realtime/index.vue`
- Test: `frontend/miniapp/tests/realtime.spec.ts`

**Step 1: Write the failing test**

Create `frontend/miniapp/tests/realtime.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import RealtimePage from '@/pages/realtime/index.vue'

describe('Miniapp Realtime', () => {
  it('loads realtime page', () => {
    expect(RealtimePage).toBeTruthy()
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/miniapp && pnpm vitest run tests/realtime.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/miniapp/pages/realtime/index.vue`:

```vue
<script setup lang="ts">
const count = ref(5)
const subscribed = ref(false)
</script>

<template>
  <view>
    <text>实时舱位</text>
    <view>热度 {{ count }}</view>
    <button @click="subscribed = true">价格提醒</button>
  </view>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/miniapp && pnpm vitest run tests/realtime.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/miniapp/pages/realtime/index.vue frontend/miniapp/tests/realtime.spec.ts
git commit -m "feat: add miniapp realtime page"
```

---

### Task 13: 小程序客服 + 天气港口信息

**Files:**
- Create: `frontend/miniapp/pages/support/index.vue`
- Create: `frontend/miniapp/pages/port/index.vue`
- Test: `frontend/miniapp/tests/support.spec.ts`

**Step 1: Write the failing test**

Create `frontend/miniapp/tests/support.spec.ts`:

```ts
import { describe, it, expect } from 'vitest'
import SupportPage from '@/pages/support/index.vue'

describe('Miniapp Support', () => {
  it('loads support page', () => {
    expect(SupportPage).toBeTruthy()
  })
})
```

**Step 2: Run test to verify it fails**

Run: `cd frontend/miniapp && pnpm vitest run tests/support.spec.ts`
Expected: FAIL with "Cannot find module"

**Step 3: Write minimal implementation**

Create `frontend/miniapp/pages/support/index.vue`:

```vue
<script setup lang="ts">
const messages = ref(['您好，请描述问题'])
</script>

<template>
  <view>
    <text>在线客服</text>
    <view v-for="m in messages" :key="m">{{ m }}</view>
  </view>
</template>
```

Create `frontend/miniapp/pages/port/index.vue`:

```vue
<script setup lang="ts">
const info = ref({ port: 'Shanghai', weather: 'sunny' })
</script>

<template>
  <view>
    <text>港口信息</text>
    <view>{{ info.port }} - {{ info.weather }}</view>
  </view>
</template>
```

**Step 4: Run test to verify it passes**

Run: `cd frontend/miniapp && pnpm vitest run tests/support.spec.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/miniapp/pages/support/index.vue frontend/miniapp/pages/port/index.vue frontend/miniapp/tests/support.spec.ts
git commit -m "feat: add miniapp support and port pages"
```

---

## Part E: CI (Task 14)

### Task 14: CI 增加 WebSocket 与客服测试

**Files:**
- Modify: `.github/workflows/ci.yml`
- Create: `scripts/verify_ci_sprint8_test.go`

**Step 1: Write the failing test**

Create `scripts/verify_ci_sprint8_test.go`:

```go
package scripts

import (
    "os"
    "testing"
)

func TestCISprint8HasWebsocketStep(t *testing.T) {
    b, err := os.ReadFile(".github/workflows/ci.yml")
    if err != nil {
        t.Fatal(err)
    }
    if len(b) == 0 {
        t.Fatal("expected workflow")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `go test ./scripts -run TestCISprint8HasWebsocketStep -v`
Expected: FAIL if file missing or empty

**Step 3: Write minimal implementation**

Modify `.github/workflows/ci.yml` to add a step:

```yaml
- name: Test Websocket
  run: cd backend && go test ./internal/service -run TestHubBroadcast -v
```

**Step 4: Run test to verify it passes**

Run: `go test ./scripts -run TestCISprint8HasWebsocketStep -v`
Expected: PASS

**Step 5: Commit**

```bash
git add .github/workflows/ci.yml scripts/verify_ci_sprint8_test.go
git commit -m "ci: add sprint8 websocket test step"
```

---

## Final Verification

Run:

```bash
cd backend && go test ./... -v
cd frontend/admin && pnpm vitest run
cd frontend/web && pnpm vitest run
cd frontend/miniapp && pnpm vitest run
```

Expected: All tests pass.
